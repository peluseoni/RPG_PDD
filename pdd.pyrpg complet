import random
import time
import sys
import json
import os
from colorama import Fore, Style, init

init(autoreset=True)


class Missao:
    def __init__(self, id, nome, descricao, tipo, alvo, quantidade, progresso, gold_recompensa, exp_recompensa):
        self.id = id
        self.nome = nome
        self.descricao = descricao
        self.tipo = tipo  
        self.alvo = alvo  
        self.quantidade = quantidade
        self.progresso = progresso
        self.gold_recompensa = gold_recompensa
        self.exp_recompensa = exp_recompensa

    def to_dict(self):
        return {
            "id": self.id,
            "nome": self.nome,
            "descricao": self.descricao,
            "tipo": self.tipo,
            "alvo": self.alvo,
            "quantidade": self.quantidade,
            "progresso": self.progresso,
            "gold_recompensa": self.gold_recompensa,
            "exp_recompensa": self.exp_recompensa
        }

    @classmethod
    def from_dict(cls, data):
        if data is None:
            return None
        return cls(
            data["id"], data["nome"], data["descricao"], data["tipo"], 
            data["alvo"], data["quantidade"], data["progresso"], 
            data["gold_recompensa"], data["exp_recompensa"]
        )


class Item:
    def __init__(self, nome, preco, descricao="Um item comum."):
        self.nome = nome
        self.descricao = descricao
        self.preco = preco 

    def __str__(self):
        return f"{self.nome} (Gold: {self.preco}) - {self.descricao}"
    
    def to_dict(self):
        return {
            "__class__": self.__class__.__name__,
            "nome": self.nome,
            "preco": self.preco,
            "descricao": self.descricao
        }

    @classmethod
    def from_dict(cls, data):
        if data is None:
            return None

        return cls(data["nome"], data["preco"], data["descricao"])

class Consumivel(Item):
    def __init__(self, nome, preco, descricao, efeito_pv=0, efeito_vigor=0, remove_condicao=None):
        super().__init__(nome, preco, descricao)
        self.efeito_pv = efeito_pv
        self.efeito_vigor = efeito_vigor
        self.remove_condicao = remove_condicao

    def usar(self, alvo):
        usado = False
        if self.efeito_pv > 0:
            alvo.vida = min(alvo.vida_max, alvo.vida + self.efeito_pv)
            print(f"{Fore.GREEN} {alvo.nome} usou {self.nome} e recuperou {self.efeito_pv} PV. Vida atual: {alvo.vida}/{alvo.vida_max}{Style.RESET_ALL}")
            usado = True
        
        if self.efeito_vigor > 0:
            alvo.vigor = min(alvo.vigor_max, alvo.vigor + self.efeito_vigor)
            print(f"{Fore.GREEN} {alvo.nome} usou {self.nome} e recuperou {self.efeito_vigor} Vigor. Vigor atual: {alvo.vigor}/{alvo.vigor_max}{Style.RESET_ALL}")
            usado = True

        if self.remove_condicao and self.remove_condicao in alvo.condicoes:
            del alvo.condicoes[self.remove_condicao]
            print(f"{Fore.GREEN}ü©π {alvo.nome} usou {self.nome} e removeu a condi√ß√£o {self.remove_condicao}.{Style.RESET_ALL}")
            usado = True
        
        return usado
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            "efeito_pv": self.efeito_pv,
            "efeito_vigor": self.efeito_vigor,
            "remove_condicao": self.remove_condicao
        })
        return data

    @classmethod
    def from_dict(cls, data):
        return cls(
            data["nome"], data["preco"], data["descricao"], 
            data["efeito_pv"], data["efeito_vigor"], data["remove_condicao"]
        )

class Equipamento(Item):
    def __init__(self, nome, preco, slot, bonus_ataque=0, bonus_defesa=0, bonus_velocidade=0, descricao="Um equipamento."):
        super().__init__(nome, preco, descricao)
        self.slot = slot
        self.bonus_ataque = bonus_ataque
        self.bonus_defesa = bonus_defesa
        self.bonus_velocidade = bonus_velocidade
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            "slot": self.slot,
            "bonus_ataque": self.bonus_ataque,
            "bonus_defesa": self.bonus_defesa,
            "bonus_velocidade": self.bonus_velocidade
        })
        return data

    @classmethod
    def from_dict(cls, data):
        return cls(
            data["nome"], data["preco"], data["slot"], 
            data["bonus_ataque"], data["bonus_defesa"], data["bonus_velocidade"], 
            data["descricao"]
        )

class Luva(Equipamento):
    def __init__(self, nome, preco, bonus_ataque, descricao="Luvas que aumentam o ataque."):
        super().__init__(nome, preco, "luva", bonus_ataque=bonus_ataque, descricao=descricao)

    @classmethod
    def from_dict(cls, data):
        return cls(data["nome"], data["preco"], data["bonus_ataque"], data["descricao"])

class Quimono(Equipamento):
    def __init__(self, nome, preco, bonus_defesa, descricao="Quimono que aumenta a defesa."):
        super().__init__(nome, preco, "armadura", bonus_defesa=bonus_defesa, descricao=descricao)

    @classmethod
    def from_dict(cls, data):
        return cls(data["nome"], data["preco"], data["bonus_defesa"], data["descricao"])

class Acessorio(Equipamento):
    def __init__(self, nome, preco, bonus_velocidade, descricao="Acess√≥rio que aumenta a velocidade."):
        super().__init__(nome, preco, "acessorio", bonus_velocidade=bonus_velocidade, descricao=descricao)

    @classmethod
    def from_dict(cls, data):
        return cls(data["nome"], data["preco"], data["bonus_velocidade"], data["descricao"])


class Habilidade:
    def __init__(self, nome, custo_vigor, dano_base, descricao, nivel_habilidade=1):
        self.nome = nome
        self.custo_vigor = custo_vigor
        self.dano_base = dano_base
        self.descricao = descricao
        self.nivel_habilidade = nivel_habilidade
        self.max_nivel = 5 

    def __str__(self):
        return f"{self.nome} (N√≠vel {self.nivel_habilidade}/{self.max_nivel} | Custo: {self.custo_vigor} Vigor | Dano Base: {self.dano_base}): {self.descricao}"

    def melhorar(self):
        if self.nivel_habilidade < self.max_nivel:
            self.nivel_habilidade += 1
            self.dano_base = int(self.dano_base * 1.1)
            self.custo_vigor = max(5, self.custo_vigor - 1) 
            return True
        return False
    
    def to_dict(self):
        return {
            "__class__": self.__class__.__name__,
            "nome": self.nome,
            "custo_vigor": self.custo_vigor,
            "dano_base": self.dano_base,
            "descricao": self.descricao,
            "nivel_habilidade": self.nivel_habilidade
        }

    @classmethod
    def from_dict(cls, data):
        return cls(
            data["nome"], data["custo_vigor"], data["dano_base"], 
            data["descricao"], data["nivel_habilidade"]
        )

CLASS_MAP = {
    "Missao": Missao,
    "Consumivel": Consumivel,
    "Equipamento": Equipamento,
    "Luva": Luva,
    "Quimono": Quimono,
    "Acessorio": Acessorio,
    "Habilidade": Habilidade,
}

SAVE_FILE = "rpg_save_data.json"

def save_game(heroi, config_data):
    """Salva o estado do jogo (her√≥i e configura√ß√µes) em um arquivo JSON."""
    try:
        heroi_data = heroi.to_dict()
        
        full_data = {
            "heroi": heroi_data,
            "config": config_data
        }
        
        with open(SAVE_FILE, 'w', encoding='utf-8') as f:
            json.dump(full_data, f, indent=4, ensure_ascii=False)
        
        print(f"\n{Fore.GREEN}*** Jogo salvo automaticamente em '{SAVE_FILE}'! ***{Style.RESET_ALL}")
    except Exception as e:
        print(f"{Fore.RED}ERRO ao salvar o jogo: {e}{Style.RESET_ALL}")

def load_game():
    """Carrega o estado do jogo a partir do arquivo JSON."""
    if not os.path.exists(SAVE_FILE):
        return None, None

    try:
        with open(SAVE_FILE, 'r', encoding='utf-8') as f:
            full_data = json.load(f)
        
        config_data = full_data.get("config", {})
        
        heroi_data = full_data.get("heroi")
        if heroi_data:
            heroi = GuerreiroDoPunho.from_dict(heroi_data)
        else:
            heroi = None

        print(f"\n{Fore.GREEN}*** Jogo carregado com sucesso de '{SAVE_FILE}'! ***{Style.RESET_ALL}")
        return heroi, config_data
    except Exception as e:
        print(f"{Fore.RED}ERRO ao carregar o jogo: Arquivo corrompido ou formato inv√°lido. Iniciando novo jogo. ({e}){Style.RESET_ALL}")
        return None, None

def deserialize_object(data):
    """Fun√ß√£o auxiliar para desserializar objetos com base na chave __class__."""
    if data is None:
        return None
    
    class_name = data.get("__class__")
    if class_name in CLASS_MAP:
        cls = CLASS_MAP[class_name]
        if class_name in ["Luva", "Quimono", "Acessorio"]:
            return cls.from_dict(data)
        elif class_name == "Equipamento":
            return cls.from_dict(data)
        elif class_name == "Consumivel":
            return cls.from_dict(data)
        elif class_name == "Habilidade":
            return cls.from_dict(data)
        else:
            return cls.from_dict(data)

    return data

class Personagem:
    def __init__(self, nome, vida, vigor_max, ataque, defesa, velocidade, nivel=1):
        self.nome = nome
        self.vida_max = vida
        self.vida = vida
        self.vigor_max = vigor_max
        self.vigor = vigor_max
        self.ataque_base = ataque
        self.defesa_base = defesa
        self.velocidade_base = velocidade
        self.nivel = nivel
        self.condicoes = {} 
        self.habilidades = []

    def esta_vivo(self):
        return self.vida > 0

    def get_ataque_total(self):
        return self.ataque_base

    def get_defesa_total(self):
        return self.defesa_base

    def get_velocidade_total(self):
        return self.velocidade_base
    
    def atacar(self, alvo, habilidade=None):
        if 'Atordoado' in self.condicoes:
            print(f"{Fore.YELLOW}{self.nome} est√° Atordoado e n√£o pode agir!{Style.RESET_ALL}")
            return False

        if habilidade:
            custo_vigor_final = habilidade.custo_vigor
            
            if isinstance(self, GuerreiroDoPunho):
                if self.talento == "Vigor Incans√°vel":
                    custo_vigor_final = int(habilidade.custo_vigor * 0.9)

            if self.vigor < custo_vigor_final:
                print(f"{Fore.RED}{self.nome} n√£o tem Vigor suficiente para usar {habilidade.nome}!{Style.RESET_ALL}")
                return False

            self.vigor -= custo_vigor_final
            dano_bruto = habilidade.dano_base + (self.get_ataque_total() * 0.5)
            
            if isinstance(self, GuerreiroDoPunho):
                if 'Atordoado' in alvo.condicoes:
                    self.karma = max(-100, self.karma - 5)
                    print(f"{Fore.RED} {self.nome} atacou um alvo Atordoado. Karma reduzido para {self.karma}.{Style.RESET_ALL}")

                if self.talento == "Poder Focado":
                    dano_bruto += habilidade.dano_base * 0.1

            print(f"{Fore.CYAN} {self.nome} usa {habilidade.nome}!{Style.RESET_ALL}")
        else:
            vigor_gerado = 5
            self.vigor = min(self.vigor_max, self.vigor + vigor_gerado)
            dano_bruto = self.get_ataque_total() * 0.75
            print(f" {self.nome} desfere um {Fore.GREEN}Ataque B√°sico{Style.RESET_ALL} e gera {vigor_gerado} Vigor.")

        dano_final = max(1, int(dano_bruto - (alvo.get_defesa_total() * 0.5)))
        alvo.receber_dano(dano_final, self)
        return True

    def receber_dano(self, dano, atacante):
        if 'Bloqueio de Guarda' in self.condicoes:
            dano = int(dano * 0.5)
            print(f"{Fore.BLUE}Dano reduzido pela metade devido ao Bloqueio de Guarda!{Style.RESET_ALL}")

        self.vida -= dano
        print(f"{Fore.RED}{self.nome} recebeu {dano} de dano. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
        
        if isinstance(self, GuerreiroDoPunho) and self.esta_vivo():
            habilidade_contra = next((h for h in self.habilidades if h.nome == "Contra-Ataque"), None)
            if habilidade_contra and self.vigor >= habilidade_contra.custo_vigor and dano > 0 and random.random() < 0.5: 
                self.vigor -= habilidade_contra.custo_vigor
                dano_contra = habilidade_contra.dano_base + (self.get_ataque_total() * 0.75)
                print(f"{Fore.YELLOW} {self.nome} REVIDA com Contra-Ataque!{Style.RESET_ALL}")
                atacante.receber_dano(int(dano_contra), self)
                
        if not self.esta_vivo():
            print(f"{Fore.RED} {self.nome} foi derrotado!{Style.RESET_ALL}")

    def aplicar_condicao(self, condicao, duracao):
        if isinstance(self, GuerreiroDoPunho) and self.talento == "Mente Clara" and condicao in ["Sangramento", "Veneno", "Queimadura"]:
            if random.random() < 0.5: 
                print(f"{Fore.CYAN} {self.nome} resistiu √† condi√ß√£o {condicao} devido ao Talento Mente Clara!{Style.RESET_ALL}")
                return

        self.condicoes[condicao] = duracao
        print(f"{Fore.YELLOW} {self.nome} agora est√° sob a condi√ß√£o: {condicao} por {duracao} turno(s).{Style.RESET_ALL}")

    def processar_condicoes(self):
        condicoes_para_remover = []
        for condicao, duracao in list(self.condicoes.items()):
            if condicao == 'Sangramento':
                dano_sangramento = int(self.vida_max * 0.05)
                self.vida -= dano_sangramento
                print(f"{Fore.RED} {self.nome} sofre dano de Sangramento: {dano_sangramento}. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
                if not self.esta_vivo():
                    break
            
            elif condicao == 'Veneno':
                dano_veneno = int(self.vida_max * 0.03)
                self.vida -= dano_veneno
                print(f"{Fore.MAGENTA} {self.nome} sofre dano de Veneno: {dano_veneno}. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
                if not self.esta_vivo():
                    break
            
            elif condicao == 'Queimadura':
                dano_queimadura = int(self.vida_max * 0.04)
                self.vida -= dano_queimadura
                print(f"{Fore.RED} {self.nome} sofre dano de Queimadura: {dano_queimadura}. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
                if not self.esta_vivo():
                    break
            
            elif condicao == 'Atordoado':
                print(f"{Fore.YELLOW} {self.nome} est√° Atordoado e perde o turno.{Style.RESET_ALL}")
            
            elif condicao == 'Bloqueio de Guarda':
                pass 

            self.condicoes[condicao] -= 1
            if self.condicoes[condicao] <= 0:
                condicoes_para_remover.append(condicao)

        for condicao in condicoes_para_remover:
            del self.condicoes[condicao]
            print(f"{Fore.GREEN} Condi√ß√£o {condicao} removida de {self.nome}.{Style.RESET_ALL}")

    def recuperar_vigor_turno(self):
        recuperacao = 10
        if isinstance(self, GuerreiroDoPunho) and self.talento == "Vigor Incans√°vel":
            recuperacao += 5
        
        self.vigor = min(self.vigor_max, self.vigor + recuperacao)
        print(f"{Fore.BLUE} {self.nome} recuperou {recuperacao} Vigor. Vigor atual: {self.vigor}/{self.vigor_max}{Style.RESET_ALL}")

    def to_dict(self):
        return {
            "__class__": self.__class__.__name__,
            "nome": self.nome,
            "vida_max": self.vida_max,
            "vida": self.vida,
            "vigor_max": self.vigor_max,
            "vigor": self.vigor,
            "ataque_base": self.ataque_base,
            "defesa_base": self.defesa_base,
            "velocidade_base": self.velocidade_base,
            "nivel": self.nivel,
            "condicoes": self.condicoes,
            "habilidades": [h.to_dict() for h in self.habilidades]
        }

    @classmethod
    def from_dict(cls, data):
        instance = cls(
            data["nome"], data["vida_max"], data["vigor_max"], 
            data["ataque_base"], data["defesa_base"], data["velocidade_base"], 
            data["nivel"]
        )
        instance.vida = data["vida"]
        instance.vigor = data["vigor"]
        instance.condicoes = data["condicoes"]
        instance.habilidades = [deserialize_object(h_data) for h_data in data["habilidades"]]
        return instance


class GuerreiroDoPunho(Personagem):
    def __init__(self, nome, subclasse, nivel=1):
        stats = {
            "Mestre do Punho": {"vida": 120, "vigor": 100, "ataque": 20, "defesa": 15, "velocidade": 15},
            "Tanque de Ferro": {"vida": 150, "vigor": 80, "ataque": 15, "defesa": 25, "velocidade": 10},
            "Vento Veloz": {"vida": 100, "vigor": 120, "ataque": 18, "defesa": 10, "velocidade": 25}
        }
        
        base = stats.get(subclasse, stats["Mestre do Punho"])
        
        super().__init__(nome, base["vida"], base["vigor"], base["ataque"], base["defesa"], base["velocidade"], nivel)
        
        self.subclasse = subclasse
        self.experiencia = 0
        self.exp_para_proximo_nivel = 100
        self.talento = None
        self.gold = 0
        self.pontos_treinamento = 0
        self.missoes_completas = []
        self.missao_ativa = None
        self.karma = 0 
        self.usos_foco_vigor = 1 
        
        self.inventario = []
        self.equipamento = {"luva": None, "armadura": None, "acessorio": None}
        
        self.habilidades.append(Habilidade("Jab R√°pido", 0, 10, "Ataque r√°pido que n√£o custa vigor."))
        self.habilidades.append(Habilidade("Contra-Ataque", 20, 40, "Habilidade de Rea√ß√£o: Causa dano massivo ap√≥s ser atacado (Requer 20 Vigor)."))
        
        if subclasse == "Mestre do Punho":
            self.habilidades.append(Habilidade("Gancho Poderoso", 30, 30, "Alto dano, 30% de chance de Atordoar (1 turno)."))
        elif subclasse == "Tanque de Ferro":
            self.habilidades.append(Habilidade("Bloqueio de Guarda", 15, 0, "Reduz o pr√≥ximo dano recebido pela metade (A√ß√£o de 1 turno)."))
        elif subclasse == "Vento Veloz":
            self.habilidades.append(Habilidade("Soco no Corpo", 20, 20, "Dano moderado, reduz o Vigor M√°ximo do alvo em 5."))

    def get_ataque_total(self):
        bonus = sum(item.bonus_ataque for item in self.equipamento.values() if item)
        return self.ataque_base + bonus

    def get_defesa_total(self):
        bonus = sum(item.bonus_defesa for item in self.equipamento.values() if item)
        return self.defesa_base + bonus

    def get_velocidade_total(self):
        bonus = sum(item.bonus_velocidade for item in self.equipamento.values() if item)
        return self.velocidade_base + bonus

    def ganhar_experiencia(self, exp):
        self.experiencia += exp
        print(f"{Fore.CYAN}Voc√™ ganhou {exp} de Experi√™ncia!{Style.RESET_ALL}")
        
        while self.experiencia >= self.exp_para_proximo_nivel:
            self.nivel += 1
            self.experiencia -= self.exp_para_proximo_nivel
            self.exp_para_proximo_nivel = int(self.exp_para_proximo_nivel * 1.5)
            self.vida_max += 10
            self.vida = self.vida_max
            self.vigor_max += 5
            self.vigor = self.vigor_max
            self.ataque_base += 2
            self.defesa_base += 2
            self.velocidade_base += 2
            self.pontos_treinamento += 3
            print(f"\n{Fore.YELLOW}*** PARAB√âNS! VOC√ä SUBIU PARA O N√çVEL {self.nivel}! ***{Style.RESET_ALL}")
            print(f"Voc√™ ganhou 3 Pontos de Treinamento!")
            
            save_game(self, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})

    def equipar_item(self, item):
        if item.slot in self.equipamento:
            if self.equipamento[item.slot]:
                self.inventario.append(self.equipamento[item.slot])
            self.equipamento[item.slot] = item
            self.inventario.remove(item)
            print(f"{Fore.GREEN} {item.nome} equipado no slot {item.slot.capitalize()}.{Style.RESET_ALL}")
            return True
        return False

    def desequipar_item(self, slot):
        if slot in self.equipamento and self.equipamento[slot]:
            item = self.equipamento[slot]
            self.inventario.append(item)
            self.equipamento[slot] = None
            print(f"{Fore.YELLOW} {item.nome} desequipado do slot {slot.capitalize()}.{Style.RESET_ALL}")
            return True
        return False

    def usar_consumivel(self, indice):
        if 0 <= indice < len(self.inventario):
            item = self.inventario[indice]
            if isinstance(item, Consumivel):
                if item.usar(self):
                    self.inventario.pop(indice)
                    if not hasattr(self, 'venceu'): 
                        save_game(self, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
                    return True
                else:
                    print(f"{Fore.RED}N√£o foi poss√≠vel usar {item.nome} (sem efeito ou condi√ß√£o n√£o presente).{Style.RESET_ALL}")
                    return False
            else:
                print(f"{Fore.RED} {item.nome} n√£o √© um item consum√≠vel.{Style.RESET_ALL}")
                return False
        return False

    def escolher_talento(self):
        talentos = {
            1: ("Poder Focado", "Aumenta o dano de habilidades em 10%."),
            2: ("Vigor Incans√°vel", "Reduz o custo de vigor das habilidades em 10% e aumenta a recupera√ß√£o de vigor por turno em 5."),
            3: ("Mente Clara", "50% de chance de resistir a condi√ß√µes negativas (Sangramento, Veneno, Queimadura).")
        }
        
        while True:
            print(f"\n{Fore.YELLOW}--- ESCOLHA DE TALENTO ---{Style.RESET_ALL}")
            for i, (nome, descricao) in talentos.items():
                print(f"{i}. {nome}: {descricao}")
            
            escolha = input("Escolha o n√∫mero do Talento: ")
            
            if escolha.isdigit() and int(escolha) in talentos:
                self.talento = talentos[int(escolha)][0]
                print(f"{Fore.GREEN}Talento {self.talento} escolhido!{Style.RESET_ALL}")
                save_game(self, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
                break
            else:
                print("Escolha inv√°lida.")

    def to_dict(self):
        data = super().to_dict()
        data.update({
            "__class__": self.__class__.__name__,
            "subclasse": self.subclasse,
            "experiencia": self.experiencia,
            "exp_para_proximo_nivel": self.exp_para_proximo_nivel,
            "talento": self.talento,
            "gold": self.gold,
            "pontos_treinamento": self.pontos_treinamento,
            "missoes_completas": self.missoes_completas,
            "missao_ativa": self.missao_ativa.to_dict() if self.missao_ativa else None,
            "karma": self.karma, 
            "usos_foco_vigor": self.usos_foco_vigor,
            "inventario": [item.to_dict() for item in self.inventario],
            "equipamento": {slot: item.to_dict() if item else None for slot, item in self.equipamento.items()},
        })
        return data

    @classmethod
    def from_dict(cls, data):
        instance = cls(data["nome"], data["subclasse"], data["nivel"])
        
        instance.vida_max = data["vida_max"]
        instance.vida = data["vida"]
        instance.vigor_max = data["vigor_max"]
        instance.vigor = data["vigor"]
        instance.ataque_base = data["ataque_base"]
        instance.defesa_base = data["defesa_base"]
        instance.velocidade_base = data["velocidade_base"]
        instance.condicoes = data["condicoes"]
        
        instance.experiencia = data["experiencia"]
        instance.exp_para_proximo_nivel = data["exp_para_proximo_nivel"]
        instance.talento = data["talento"]
        instance.gold = data["gold"]
        instance.pontos_treinamento = data["pontos_treinamento"]
        instance.missoes_completas = data["missoes_completas"]
        instance.missao_ativa = Missao.from_dict(data["missao_ativa"])
        instance.karma = data["karma"]
        instance.usos_foco_vigor = data["usos_foco_vigor"]

        instance.inventario = [deserialize_object(item_data) for item_data in data["inventario"]]
        instance.equipamento = {
            slot: deserialize_object(item_data) 
            for slot, item_data in data["equipamento"].items()
        }

        instance.habilidades = [deserialize_object(h_data) for h_data in data["habilidades"]]
        
        return instance


class OponenteIA(GuerreiroDoPunho):
    def __init__(self, modelo_key):
        modelo = OPONENTE_MODELOS[modelo_key]

        super().__init__(modelo["nome"], modelo["subclasse"]) 
        
        self.nivel = modelo["nivel"]
        self.vida_max = modelo["vida"]
        self.vida = modelo["vida"]
        self.vigor_max = modelo["vigor"]
        self.vigor = modelo["vigor"]
        self.ataque_base = modelo["ataque"]
        self.defesa_base = modelo["defesa"]
        self.velocidade_base = modelo["velocidade"]
        self.talento = modelo["talento"]

        self.tipo = modelo["tipo"]
        self.gold_recompensa = modelo["gold_recompensa"]
        self.exp_recompensa = modelo["exp_recompensa"]

        self.habilidades = [h for h in self.habilidades if h.nome not in ["Jab R√°pido", "Contra-Ataque"]]
        self.habilidades.append(Habilidade("Contra-Ataque", 20, 40, "Habilidade de Rea√ß√£o: Causa dano massivo ap√≥s ser atacado (Requer 20 Vigor)."))

        if modelo_key == "Desafiante":
            self.habilidades.append(Habilidade("Golpe Venenoso", 20, 10, "Aplica Veneno (3 turnos)."))
        elif modelo_key == "Lenda":
            self.habilidades.append(Habilidade("Punho Flamejante", 25, 20, "Aplica Queimadura (2 turnos)."))

        for _ in range(1, self.nivel):
            self.vida_max += 10
            self.vida = self.vida_max
            self.vigor_max += 5
            self.vigor = self.vigor_max
            self.ataque_base += 2
            self.defesa_base += 2
            self.velocidade_base += 2


    def acao_ia(self, heroi):
        
        habilidades_controle = [h for h in self.habilidades if h.nome in ["Gancho Poderoso", "Terremoto de Punho"] and self.vigor >= h.custo_vigor]
        if habilidades_controle and random.random() < 0.4 and "Atordoado" not in heroi.condicoes:
            h = random.choice(habilidades_controle)
            if self.atacar(heroi, h):
                heroi.aplicar_condicao("Atordoado", 1)
                return

        habilidades_dano = [h for h in self.habilidades if h.dano_base > 20 and self.vigor >= h.custo_vigor]
        if habilidades_dano and random.random() < 0.6:
            self.atacar(heroi, random.choice(habilidades_dano))
            return

        if self.subclasse == "Tanque de Ferro" and self.vida > self.vida_max * 0.7 and "Bloqueio de Guarda" not in self.condicoes:
            bloqueio = next((h for h in self.habilidades if h.nome == "Bloqueio de Guarda"), None)
            if bloqueio and self.vigor >= bloqueio.custo_vigor:
                self.aplicar_condicao("Bloqueio de Guarda", 1)
                self.vigor -= bloqueio.custo_vigor
                print(f"{Fore.BLUE}üõ°Ô∏è {self.nome} assume Postura de Bloqueio de Guarda.{Style.RESET_ALL}")
                return

        self.atacar(heroi)

def iniciar_combate(heroi, oponente):
    print(f"\n{Fore.RED}--- COMBATE INICIADO! ---{Style.RESET_ALL}")
    print(f"{Fore.GREEN}{heroi.nome} (N√≠vel {heroi.nivel}){Style.RESET_ALL} vs {Fore.RED}{oponente.nome} (N√≠vel {oponente.nivel}){Style.RESET_ALL}")
    time.sleep(1)

    turno = 1
    heroi.usos_foco_vigor = 1 

    heroi_velocidade = heroi.get_velocidade_total()
    if heroi.karma < -50:
        heroi_velocidade = max(1, heroi_velocidade - 5)
        print(f"{Fore.RED}A hostilidade ao seu redor reduz sua velocidade de combate!{Style.RESET_ALL}")

    if heroi_velocidade >= oponente.get_velocidade_total():
        primeiro = heroi
        segundo = oponente
    else:
        primeiro = oponente
        segundo = heroi

    while heroi.esta_vivo() and oponente.esta_vivo():
        print(f"\n{Fore.YELLOW}==== TURNO {turno} ===={Style.RESET_ALL}")

        primeiro.processar_condicoes()
        segundo.processar_condicoes()
        
        if not heroi.esta_vivo() or not oponente.esta_vivo():
            break

        primeiro.recuperar_vigor_turno()
        segundo.recuperar_vigor_turno()

        if primeiro.esta_vivo():
            if primeiro == heroi:
                menu_combate(heroi, oponente)
            else:
                primeiro.acao_ia(heroi)
        
        if not heroi.esta_vivo() or not oponente.esta_vivo():
            break

        if segundo.esta_vivo():
            if segundo == heroi:
                menu_combate(heroi, oponente)
            else:
                segundo.acao_ia(heroi)

        turno += 1
        time.sleep(1)

    heroi.venceu = heroi.esta_vivo()
    
    if heroi.venceu:
        print(f"\n{Fore.GREEN}VIT√ìRIA!{Style.RESET_ALL}")
        gold_ganho = oponente.gold_recompensa
        exp_ganha = oponente.exp_recompensa

        if heroi.karma > 50:
            bonus = int(gold_ganho * 0.25)
            gold_ganho += bonus
            print(f"{Fore.YELLOW}Sua reputa√ß√£o lhe rendeu um b√¥nus de {bonus} Gold!{Style.RESET_ALL}")

        heroi.gold += gold_ganho
        heroi.ganhar_experiencia(exp_ganha) 

        if heroi.missao_ativa and heroi.missao_ativa.tipo == "derrotar_monstro" and heroi.missao_ativa.alvo == oponente.tipo:
            heroi.missao_ativa.progresso += 1
            print(f"{Fore.CYAN}Progresso da Miss√£o: {heroi.missao_ativa.progresso}/{heroi.missao_ativa.quantidade}{Style.RESET_ALL}")
        
        print(f"Voc√™ ganhou {Fore.YELLOW}{gold_ganho} Gold{Style.RESET_ALL} e {Fore.CYAN}{exp_ganha} EXP{Style.RESET_ALL}!")

        if oponente.vida <= 0:
            print(f"\n{Fore.YELLOW}O corpo de {oponente.nome} jaz no ch√£o. O que voc√™ faz?{Style.RESET_ALL}")
            print("1. Ignorar e seguir em frente.")
            print("2. Prestar os primeiros socorros (Aumenta Karma).")
            
            escolha = input("Op√ß√£o: ")
            if escolha == '2':
                heroi.karma = min(100, heroi.karma + 5)
                print(f"{Fore.GREEN}Voc√™ demonstrou piedade. Karma aumentado para {heroi.karma}.{Style.RESET_ALL}")

        if not heroi.experiencia >= heroi.exp_para_proximo_nivel:
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})

        return True 
    else:
        print(f"\n{Fore.RED}DERROTA!{Style.RESET_ALL}")
        save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
        return False

def iniciar_torneio(heroi):
    
    if heroi.nivel < 5:
        print(f"{Fore.RED}Voc√™ deve ser no m√≠nimo N√≠vel 5 para entrar no Torneio do Punho Ascendente!{Style.RESET_ALL}")
        return False

    missao_torneio = heroi.missao_ativa and heroi.missao_ativa.id == "TORNEIO"
    
    if missao_torneio:
        print(f"{Fore.YELLOW}Iniciando o Torneio, objetivo da Miss√£o Principal!{Style.RESET_ALL}")

    print(f"\n{Fore.MAGENTA}*** TORNEIO DO PUNHO ASCENDENTE INICIADO! ***{Style.RESET_ALL}")

    oponentes = ["Lutador", "Mestre", "Desafiante", "Lenda"]
    vitorias = 0
    
    for nome_oponente in oponentes:
        oponente = OponenteIA(nome_oponente)
        print(f"\n{Fore.YELLOW}--- PR√ìXIMO OPONENTE: {oponente.nome} ({oponente.subclasse}) ---{Style.RESET_ALL}")
        time.sleep(1)
        
        if not iniciar_combate(heroi, oponente):
            print(f"{Fore.RED}Voc√™ foi derrotado por {oponente.nome} e eliminado do Torneio!{Style.RESET_ALL}")
            return False
        
        vitorias += 1
        print(f"\n{Fore.GREEN}Vit√≥ria contra {oponente.nome}! Prepare-se para o pr√≥ximo round.{Style.RESET_ALL}")
        heroi.vida = heroi.vida_max 
        heroi.vigor = heroi.vigor_max
        heroi.usos_foco_vigor = 1
        input("Pressione ENTER para continuar para o pr√≥ximo round...")

    print(f"\n{Fore.YELLOW}*** PARAB√âNS! VOC√ä √â O CAMPE√ÉO DO TORNEIO DO PUNHO ASCENDENTE! ***{Style.RESET_ALL}")

    gold_premio = 500
    exp_premio = 1000
    
    heroi.gold += gold_premio
    heroi.ganhar_experiencia(exp_premio)

    item_unico = Luva("Punho do Destino", 1000, 25, "Luvas lend√°rias. +25 Ataque. N√£o pode ser vendido.")
    heroi.inventario.append(item_unico)
    
    print(f"{Fore.YELLOW}Recompensa: {gold_premio} Gold, {exp_premio} EXP e o item lend√°rio '{item_unico.nome}'!{Style.RESET_ALL}")

    save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
    
    return True

def menu_combate(heroi, alvo):
    while True:
        print(f"\n{Fore.GREEN}--- SEU TURNO ---{Style.RESET_ALL}")
        print(f"PV: {Fore.RED}{heroi.vida}/{heroi.vida_max}{Style.RESET_ALL} | Vigor: {Fore.BLUE}{heroi.vigor}/{heroi.vigor_max}{Style.RESET_ALL} | Condi√ß√µes: {', '.join(heroi.condicoes.keys()) if heroi.condicoes else 'Nenhuma'}")
        print(f"Alvo PV: {Fore.RED}{alvo.vida}/{alvo.vida_max}{Style.RESET_ALL} | Alvo Condi√ß√µes: {', '.join(alvo.condicoes.keys()) if alvo.condicoes else 'Nenhuma'}")
        
        print("\nOp√ß√µes:")
        print("1. Ataque B√°sico (Gera Vigor)")
        print("2. Habilidades de Combate")
        print("3. Usar Item Consum√≠vel")
        
        escolha = input("Escolha a a√ß√£o: ")
        
        if escolha == '1':
            heroi.atacar(alvo)
            break
        elif escolha == '2':
            if menu_habilidades(heroi, alvo):
                break
        elif escolha == '3':
            if acao_item_combate(heroi):
                break
        else:
            print("Op√ß√£o inv√°lida.")

def menu_habilidades(heroi, alvo):
    habilidades_validas = [h for h in heroi.habilidades if h.nome != "Jab R√°pido"]
    
    if not habilidades_validas:
        print("Voc√™ n√£o possui Habilidades de A√ß√£o.")
        return False

    print(f"\n{Fore.YELLOW}--- HABILIDADES DISPON√çVEIS ---{Style.RESET_ALL}")
    for i, h in enumerate(habilidades_validas):
        custo_final = h.custo_vigor
        if heroi.talento == "Vigor Incans√°vel":
            custo_final = int(h.custo_vigor * 0.9)

        if heroi.vigor >= custo_final:
            print(f"{i+1}. {h.nome} (N√≠vel {h.nivel_habilidade}/{h.max_nivel} | Custo: {Fore.BLUE}{custo_final} Vigor{Style.RESET_ALL}) - {h.descricao}")
        else:
            print(f"{i+1}. {h.nome} (N√≠vel {h.nivel_habilidade} | {Fore.RED}Vigor Insuficiente - Custo: {custo_final}{Style.RESET_ALL})")
    
    print("0. Voltar")

    while True:
        escolha = input("Escolha a Habilidade (0 para voltar): ")
        if escolha == '0':
            return False
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(habilidades_validas):
            habilidade_escolhida = habilidades_validas[int(escolha) - 1]
            
            if habilidade_escolhida.nome == "Bloqueio de Guarda":
                custo = habilidade_escolhida.custo_vigor
                if heroi.vigor < custo:
                    print(f"{Fore.RED}Vigor insuficiente para Bloqueio de Guarda.{Style.RESET_ALL}")
                    continue
                heroi.aplicar_condicao("Bloqueio de Guarda", 1)
                heroi.vigor -= custo
                print(f"{Fore.BLUE} {heroi.nome} assume Postura de Bloqueio de Guarda.{Style.RESET_ALL}")
                return True
            
            elif habilidade_escolhida.nome == "Gancho Poderoso":
                if heroi.atacar(alvo, habilidade_escolhida):
                    if random.random() < 0.3: 
                        alvo.aplicar_condicao("Atordoado", 1)
                    return True
                return False
            
            elif habilidade_escolhida.nome == "Foco de Vigor":
                if heroi.usos_foco_vigor > 0:
                    heroi.vigor = min(heroi.vigor_max, heroi.vigor + 15)
                    heroi.usos_foco_vigor -= 1
                    print(f"{Fore.YELLOW} {heroi.nome} foca o Vigor. +15 Vigor. Usos restantes: {heroi.usos_foco_vigor}{Style.RESET_ALL}")
                    return True
                else:
                    print(f"{Fore.RED}Voc√™ j√° usou Foco de Vigor nesta batalha.{Style.RESET_ALL}")
                    continue
            
            elif habilidade_escolhida.nome == "Soco no Corpo":
                if heroi.atacar(alvo, habilidade_escolhida):
                    alvo.vigor_max = max(10, alvo.vigor_max - 5) 
                    alvo.vigor = min(alvo.vigor, alvo.vigor_max)
                    print(f"{Fore.YELLOW}Vigor M√°ximo de {alvo.nome} reduzido para {alvo.vigor_max}.{Style.RESET_ALL}")
                    return True
                return False

            elif habilidade_escolhida.nome == "Terremoto de Punho":
                if heroi.atacar(alvo, habilidade_escolhida):
                    alvo.aplicar_condicao("Atordoado", 1)
                    return True
                return False
            
            elif habilidade_escolhida.nome == "Combo Girat√≥rio":
                if heroi.atacar(alvo, habilidade_escolhida): 
                    dano_adicional = heroi.get_ataque_total() * 0.5
                    alvo.receber_dano(int(dano_adicional), heroi)
                    alvo.receber_dano(int(dano_adicional), heroi)
                    return True
                return False

            elif heroi.atacar(alvo, habilidade_escolhida):
                return True
            return False

        else:
            print("Escolha inv√°lida.")

def acao_item_combate(heroi):
    consumiveis = [item for item in heroi.inventario if isinstance(item, Consumivel)]
    
    if not consumiveis:
        print("Voc√™ n√£o tem itens consum√≠veis no invent√°rio.")
        return False

    print(f"\n{Fore.YELLOW}--- CONSUM√çVEIS DISPON√çVEIS ---{Style.RESET_ALL}")
    for i, item in enumerate(consumiveis):
        print(f"{i+1}. {item.nome} - {item.descricao}")
    
    print("0. Voltar")

    while True:
        escolha = input("Escolha o Item para usar (0 para voltar): ")
        if escolha == '0':
            return False
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(consumiveis):
            item_escolhido = consumiveis[int(escolha) - 1]
            
            indice_real = heroi.inventario.index(item_escolhido)
            
            if heroi.usar_consumivel(indice_real):
                return True
            else:
                continue 
        else:
            print("Escolha inv√°lida.")

def mostrar_status(heroi):
    print(f"\n{Fore.GREEN}--- STATUS DO HER√ìI ---{Style.RESET_ALL}")
    print(f"Nome: {heroi.nome}")
    print(f"Classe: Guerreiro do Punho ({heroi.subclasse})")
    print(f"N√≠vel: {heroi.nivel}")
    print(f"Experi√™ncia: {heroi.experiencia}/{heroi.exp_para_proximo_nivel}")
    print(f"Pontos de Treinamento: {Fore.CYAN}{heroi.pontos_treinamento}{Style.RESET_ALL}")
    print(f"Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
    
    karma_status = "Neutro"
    karma_cor = Style.RESET_ALL
    if heroi.karma > 50:
        karma_status = "Bom"
        karma_cor = Fore.GREEN
    elif heroi.karma < -50:
        karma_status = "Ruim"
        karma_cor = Fore.RED
        
    print(f"Karma: {karma_cor}{karma_status} ({heroi.karma}){Style.RESET_ALL}")
    
    print(f"\nAtributos Base:")
    print(f"  PV M√°ximo: {heroi.vida_max}")
    print(f"  Vigor M√°ximo: {heroi.vigor_max}")
    print(f"  Ataque Base: {heroi.ataque_base}")
    print(f"  Defesa Base: {heroi.defesa_base}")
    print(f"  Velocidade Base: {heroi.velocidade_base}")
    
    print(f"\nAtributos Totais:")
    print(f"  Ataque Total: {heroi.get_ataque_total()}")
    print(f"  Defesa Total: {heroi.get_defesa_total()}")
    print(f"  Velocidade Total: {heroi.get_velocidade_total()}")
    
    print(f"\nTalento: {Fore.MAGENTA}{heroi.talento if heroi.talento else 'Nenhum'}{Style.RESET_ALL}")
    
    print(f"\nEquipamento:")
    for slot, item in heroi.equipamento.items():
        print(f"  {slot.capitalize()}: {item.nome if item else 'Vazio'}")
        
    print(f"\nHabilidades:")
    for h in heroi.habilidades:
        print(f"  - {h}")
        
    print(f"\nMiss√£o Ativa:")
    if heroi.missao_ativa:
        print(f"  ID: {heroi.missao_ativa.id}")
        print(f"  Nome: {heroi.missao_ativa.nome}")
        print(f"  Progresso: {heroi.missao_ativa.progresso}/{heroi.missao_ativa.quantidade}")
    else:
        print("  Nenhuma")
        
    print(f"\nMiss√µes Completas: {', '.join(heroi.missoes_completas) if heroi.missoes_completas else 'Nenhuma'}")
    
    input("\nPressione ENTER para continuar...")

def menu_inventario(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- INVENT√ÅRIO ---{Style.RESET_ALL}")
        
        if not heroi.inventario:
            print("O invent√°rio est√° vazio.")
            input("Pressione ENTER para continuar...")
            break
            
        print("Itens:")
        for i, item in enumerate(heroi.inventario):
            print(f"{i+1}. {item}")
            
        print("\nOp√ß√µes:")
        print("E. Equipar Item")
        print("D. Desequipar Item")
        print("U. Usar Consum√≠vel")
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Escolha uma op√ß√£o (E/D/U/0) ou o n√∫mero do item para inspecionar: ").upper()
        
        if escolha == '0':
            break
        
        elif escolha == 'E':
            if not any(isinstance(item, Equipamento) for item in heroi.inventario):
                print(f"{Fore.RED}Nenhum equipamento no invent√°rio para equipar.{Style.RESET_ALL}")
                continue
                
            while True:
                try:
                    num = input("Digite o n√∫mero do item para EQUIPAR (0 para cancelar): ")
                    if num == '0':
                        break
                    num = int(num)
                    if 1 <= num <= len(heroi.inventario):
                        item = heroi.inventario[num - 1]
                        if isinstance(item, Equipamento):
                            heroi.equipar_item(item)
                            break
                        else:
                            print(f"{Fore.RED}O item {item.nome} n√£o √© um equipamento.{Style.RESET_ALL}")
                    else:
                        print("N√∫mero inv√°lido.")
                except ValueError:
                    print("Entrada inv√°lida.")
        
        elif escolha == 'D':
            if not any(item for item in heroi.equipamento.values()):
                print(f"{Fore.RED}Nenhum item equipado para desequipar.{Style.RESET_ALL}")
                continue
                
            print("\nSlots Equipados:")
            slots_equipados = [slot for slot, item in heroi.equipamento.items() if item]
            for i, slot in enumerate(slots_equipados):
                print(f"{i+1}. {slot.capitalize()} ({heroi.equipamento[slot].nome})")
                
            while True:
                try:
                    num = input("Digite o n√∫mero do slot para DESEQUIPAR (0 para cancelar): ")
                    if num == '0':
                        break
                    num = int(num)
                    if 1 <= num <= len(slots_equipados):
                        slot_escolhido = slots_equipados[num - 1]
                        heroi.desequipar_item(slot_escolhido)
                        break
                    else:
                        print("N√∫mero inv√°lido.")
                except ValueError:
                    print("Entrada inv√°lida.")

        elif escolha == 'U':
            if not any(isinstance(item, Consumivel) for item in heroi.inventario):
                print(f"{Fore.RED}Nenhum consum√≠vel no invent√°rio para usar.{Style.RESET_ALL}")
                continue
                
            while True:
                try:
                    num = input("Digite o n√∫mero do item para USAR (0 para cancelar): ")
                    if num == '0':
                        break
                    num = int(num)
                    if 1 <= num <= len(heroi.inventario):
                        indice_real = num - 1
                        if isinstance(heroi.inventario[indice_real], Consumivel):
                            heroi.usar_consumivel(indice_real)
                            break
                        else:
                            print(f"{Fore.RED}O item {heroi.inventario[indice_real].nome} n√£o √© um consum√≠vel.{Style.RESET_ALL}")
                    else:
                        print("N√∫mero inv√°lido.")
                except ValueError:
                    print("Entrada inv√°lida.")
        
        elif escolha.isdigit() and 1 <= int(escolha) <= len(heroi.inventario):
            item = heroi.inventario[int(escolha) - 1]
            print(f"\nDetalhes do Item: {item.nome}")
            print(f"  Descri√ß√£o: {item.descricao}")
            print(f"  Pre√ßo de Compra: {item.preco} Gold")
            if isinstance(item, Equipamento):
                print(f"  Slot: {item.slot.capitalize()}")
                print(f"  B√¥nus Ataque: {item.bonus_ataque}")
                print(f"  B√¥nus Defesa: {item.bonus_defesa}")
                print(f"  B√¥nus Velocidade: {item.bonus_velocidade}")
            elif isinstance(item, Consumivel):
                print(f"  Efeito PV: {item.efeito_pv}")
                print(f"  Efeito Vigor: {item.efeito_vigor}")
                print(f"  Remove Condi√ß√£o: {item.remove_condicao if item.remove_condicao else 'Nenhuma'}")
            input("Pressione ENTER para continuar...")
            
        else:
            print("Op√ß√£o inv√°lida.")

def menu_treinamento(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- TREINAMENTO ---{Style.RESET_ALL}")
        print(f"Pontos de Treinamento (PTs): {Fore.CYAN}{heroi.pontos_treinamento}{Style.RESET_ALL}")
        print("1. Aumentar Atributo Base (+5 por 1 PT)")
        print("2. Melhorar Habilidade (Aumenta N√≠vel por 2 PTs)")
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Escolha a op√ß√£o: ")
        
        if escolha == '0':
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
            break
        
        elif escolha == '1':
            if heroi.pontos_treinamento < 1:
                print(f"{Fore.RED}PTs insuficientes.{Style.RESET_ALL}")
                continue
            
            print("\nEscolha o Atributo para Aumentar (+5):")
            print("1. Ataque Base")
            print("2. Defesa Base")
            print("3. Velocidade Base")
            
            sub_escolha = input("Op√ß√£o: ")
            
            if sub_escolha == '1':
                heroi.ataque_base += 5
                heroi.pontos_treinamento -= 1
                print(f"{Fore.GREEN}Ataque Base aumentado para {heroi.ataque_base}.{Style.RESET_ALL}")
            elif sub_escolha == '2':
                heroi.defesa_base += 5
                heroi.pontos_treinamento -= 1
                print(f"{Fore.GREEN}Defesa Base aumentada para {heroi.defesa_base}.{Style.RESET_ALL}")
            elif sub_escolha == '3':
                heroi.velocidade_base += 5
                heroi.pontos_treinamento -= 1
                print(f"{Fore.GREEN}Velocidade Base aumentada para {heroi.velocidade_base}.{Style.RESET_ALL}")
            else:
                print("Op√ß√£o inv√°lida.")
                
        elif escolha == '2':
            if heroi.pontos_treinamento < 2:
                print(f"{Fore.RED}PTs insuficientes (Custo: 2 PT).{Style.RESET_ALL}")
                continue
            
            print("\nEscolha a Habilidade para Aumentar o N√≠vel (2 PT):")
            habilidades_melhoraveis = [h for h in heroi.habilidades if h.nivel_habilidade < h.max_nivel and h.nome != "Jab R√°pido"]
            
            if not habilidades_melhoraveis:
                print("Nenhuma habilidade para melhorar.")
                continue
            
            for i, h in enumerate(habilidades_melhoraveis):
                print(f"{i+1}. {h.nome} (N√≠vel {h.nivel_habilidade}/{h.max_nivel})")
            
            sub_escolha = input("Op√ß√£o: ")
            
            if sub_escolha.isdigit() and 1 <= int(sub_escolha) <= len(habilidades_melhoraveis):
                habilidade_escolhida = habilidades_melhoraveis[int(sub_escolha) - 1]
                if habilidade_escolhida.melhorar():
                    heroi.pontos_treinamento -= 2
                    print(f"{Fore.GREEN}Habilidade {habilidade_escolhida.nome} melhorada para N√≠vel {habilidade_escolhida.nivel_habilidade}.{Style.RESET_ALL}")
                else:
                    print(f"{Fore.RED}Habilidade j√° est√° no n√≠vel m√°ximo.{Style.RESET_ALL}")
            else:
                print("Op√ß√£o inv√°lida.")

def menu_dojo(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- DOJO DE TREINAMENTO ---{Style.RESET_ALL}")
        print("Escolha o oponente para treinar:")
        
        opcoes = list(OPONENTE_MODELOS.keys())
        for i, nome in enumerate(opcoes):
            modelo = OPONENTE_MODELOS[nome]
            print(f"{i+1}. {nome} (N√≠vel {modelo['nivel']} | {modelo['subclasse']}) - Recompensa: {modelo['exp_recompensa']} EXP / {modelo['gold_recompensa']} Gold")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Op√ß√£o: ")
        
        if escolha == '0':
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(opcoes):
            nome_oponente = opcoes[int(escolha) - 1]
            oponente = OponenteIA(nome_oponente)
            iniciar_combate(heroi, oponente)
        else:
            print("Op√ß√£o inv√°lida.")

def loja_consumiveis(heroi):
    itens_loja = [
        Consumivel("Po√ß√£o de PV Pequena", 10, "Restaura 50 Pontos de Vida.", efeito_pv=50),
        Consumivel("Elixir de Vigor Pequeno", 15, "Restaura 30 Pontos de Vigor.", efeito_vigor=30),
        Consumivel("Bandagem de Seda", 25, "Remove a condi√ß√£o Sangramento.", remove_condicao="Sangramento"),
        Consumivel("Ant√≠doto", 30, "Remove a condi√ß√£o Veneno.", remove_condicao="Veneno"),
        Consumivel("Pomada Refrescante", 35, "Remove a condi√ß√£o Queimadura.", remove_condicao="Queimadura")
    ]
    
    while True:
        print(f"\n{Fore.YELLOW}--- LOJA DE CONSUM√çVEIS ---{Style.RESET_ALL}")
        print(f"Seu Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        
        for i, item in enumerate(itens_loja):
            print(f"{i+1}. {item.nome} (Pre√ßo: {item.preco} Gold) - {item.descricao}")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Digite o n√∫mero do item para comprar (0 para voltar): ")
        
        if escolha == '0':
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(itens_loja):
            item_escolhido = itens_loja[int(escolha) - 1]
            
            if heroi.gold >= item_escolhido.preco:
                heroi.gold -= item_escolhido.preco
                heroi.inventario.append(item_escolhido)
                print(f"{Fore.GREEN} {item_escolhido.nome} comprado! Gold restante: {heroi.gold}{Style.RESET_ALL}")
            else:
                print(f"{Fore.RED}Gold insuficiente para comprar {item_escolhido.nome}.{Style.RESET_ALL}")
        else:
            print("Escolha inv√°lida.")

def vender_item(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- VENDA DE ITENS ---{Style.RESET_ALL}")
        print(f"Seu Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        
        itens_vendaveis = []
        for item in heroi.inventario:
            if item.nome != "Punho do Destino":
                itens_vendaveis.append(item)

        if not itens_vendaveis:
            print("Voc√™ n√£o tem itens vend√°veis no invent√°rio.")
            input("Pressione ENTER para continuar...")
            break

        print("\nItens no Invent√°rio:")
        for i, item in enumerate(itens_vendaveis):
            preco_venda = int(item.preco * 0.5)
            status_equipado = ""
            if item in heroi.equipamento.values():
                status_equipado = f" ({Fore.RED}EQUIPADO{Style.RESET_ALL})"

            print(f"{i+1}. {item.nome} (Venda: {Fore.YELLOW}{preco_venda} Gold{Style.RESET_ALL}){status_equipado}")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Digite o n√∫mero do item para vender (0 para voltar): ")
        
        if escolha == '0':
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(itens_vendaveis):
            item_escolhido = itens_vendaveis[int(escolha) - 1]
            
            if item_escolhido in heroi.equipamento.values():
                print(f"{Fore.RED} Voc√™ precisa desequipar {item_escolhido.nome} antes de vend√™-lo.{Style.RESET_ALL}")
                continue

            preco_venda = int(item_escolhido.preco * 0.5)
            heroi.gold += preco_venda
            heroi.inventario.remove(item_escolhido)
            
            print(f"{Fore.GREEN} {item_escolhido.nome} vendido por {preco_venda} Gold! Total: {heroi.gold}{Style.RESET_ALL}")
        else:
            print("Escolha inv√°lida.")

def loja_equipamentos(heroi):
    itens_loja = [
        Luva("Luvas de Couro Refor√ßado", 50, 8, "Aumenta o ataque."),
        Quimono("Quimono de Treino Avan√ßado", 60, 5, "Aumenta a defesa."),
        Acessorio("Peso Corporal Leve", 40, 2, "Aumenta a velocidade."),
        Luva("Manoplas de Ferro", 120, 15, "Aumenta muito o ataque."),
        Quimono("Quimono de Seda Refor√ßada", 150, 10, "Aumenta a defesa e a velocidade."),
        Acessorio("Faixa da Agilidade", 100, 5, "Aumenta muito a velocidade.")
    ]
    
    while True:
        print(f"\n{Fore.YELLOW}--- LOJA DE EQUIPAMENTOS ---{Style.RESET_ALL}")
        print(f"Seu Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        
        for i, item in enumerate(itens_loja):
            print(f"{i+1}. {item.nome} (Pre√ßo: {item.preco} Gold) - Slot: {item.slot.capitalize()}")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Digite o n√∫mero do item para comprar (0 para voltar): ")
        
        if escolha == '0':
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(itens_loja):
            item_escolhido = itens_loja[int(escolha) - 1]
            
            if heroi.gold >= item_escolhido.preco:
                heroi.gold -= item_escolhido.preco
                heroi.inventario.append(item_escolhido)
                print(f"{Fore.GREEN} {item_escolhido.nome} comprado! Gold restante: {heroi.gold}{Style.RESET_ALL}")
            else:
                print(f"{Fore.RED}Gold insuficiente para comprar {item_escolhido.nome}.{Style.RESET_ALL}")
        else:
            print("Escolha inv√°lida.")

def menu_lojas(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- LOJAS DE KAIRU ---{Style.RESET_ALL}")
        print("1. Loja de Consum√≠veis")
        print("2. Loja de Equipamentos")
        print("3. Vender Itens")
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Escolha a loja: ")
        
        if escolha == '1':
            loja_consumiveis(heroi)
        elif escolha == '2':
            loja_equipamentos(heroi)
        elif escolha == '3':
            vender_item(heroi)
        elif escolha == '0':
            break
        else:
            print("Op√ß√£o inv√°lida.")

def menu_jogo(heroi):
    print("\n" + Fore.YELLOW + "="*50)
    print(f" CIDADE DE KAIRU - DOJO CENTRAL")
    print("="*50 + Style.RESET_ALL)

    if not heroi.missao_ativa and "TORNEIO" not in heroi.missoes_completas:
        heroi.missao_ativa = Missao("TORNEIO", "Conquistar o t√≠tulo de Mestre Invicto no Torneio do Punho Ascendente.", "vencer_torneio", "Torneio", 1, 0, 500, 1000)

    if "TORNEIO" in heroi.missoes_completas and "DERROTAR_MESTRES" not in heroi.missoes_completas and not heroi.missao_ativa:
        heroi.missao_ativa = Missao("DERROTAR_MESTRES", "Derrote 3 Mestres para receber uma recompensa especial.", "derrotar_monstro", "Mestre", 3, 0, 150, 300)

    while heroi.esta_vivo():

        if heroi.missao_ativa and heroi.missao_ativa.progresso >= heroi.missao_ativa.quantidade:
            print(f"\n{Fore.YELLOW}üèÜ MISS√ÉO COMPLETA: {heroi.missao_ativa.nome}!{Style.RESET_ALL}")
            heroi.gold += heroi.missao_ativa.gold_recompensa
            heroi.ganhar_experiencia(heroi.missao_ativa.exp_recompensa)
            heroi.missoes_completas.append(heroi.missao_ativa.id)
            heroi.missao_ativa = None
            input("Pressione ENTER para continuar...")

        if random.random() < 0.1: 
            print(f"\n{Fore.YELLOW}Um jovem monge se aproxima de voc√™ no Dojo.{Style.RESET_ALL}")
            print("Ele lhe pergunta: 'Qual √© o caminho mais r√°pido para a vit√≥ria?'")
            print("1. O caminho da for√ßa bruta.")
            print("2. O caminho da defesa inabal√°vel.")
            print("3. O caminho da velocidade e agilidade.")
            
            escolha_karma = input("Sua resposta (1/2/3): ")
            if escolha_karma == '1':
                heroi.karma = max(-100, heroi.karma - 5)
                print(f"{Fore.RED}O monge se afasta com um olhar de desaprova√ß√£o. Karma: {heroi.karma}{Style.RESET_ALL}")
            elif escolha_karma == '2' or escolha_karma == '3':
                heroi.karma = min(100, heroi.karma + 5)
                print(f"{Fore.GREEN}O monge sorri e se curva em respeito. Karma: {heroi.karma}{Style.RESET_ALL}")
            
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})

        print(f"\n{Fore.CYAN}--- MENU PRINCIPAL ---{Style.RESET_ALL}")
        print(f"PV: {Fore.RED}{heroi.vida}/{heroi.vida_max}{Style.RESET_ALL} | Vigor: {Fore.BLUE}{heroi.vigor}/{heroi.vigor_max}{Style.RESET_ALL} | Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        print(f"N√≠vel: {heroi.nivel} | EXP: {heroi.experiencia}/{heroi.exp_para_proximo_nivel}")
        
        print("\nOp√ß√µes:")
        print("1. Status do Her√≥i")
        print("2. Invent√°rio e Equipamento")
        print("3. Treinamento (Usar PTs)")
        print("4. Dojo (Combate)")
        print("5. Lojas de Kairu")
        print("6. Torneio do Punho Ascendente")
        print("7. Salvar Jogo")
        print("0. Sair do Jogo")
        
        escolha = input("Escolha a op√ß√£o: ")
        
        if escolha == '1':
            mostrar_status(heroi)
        elif escolha == '2':
            menu_inventario(heroi)
        elif escolha == '3':
            menu_treinamento(heroi)
        elif escolha == '4':
            menu_dojo(heroi)
        elif escolha == '5':
            menu_lojas(heroi)
        elif escolha == '6':
            iniciar_torneio(heroi)
        elif escolha == '7':
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
        elif escolha == '0':
            print(f"\n{Fore.YELLOW}Salvando e saindo...{Style.RESET_ALL}")
            save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
            break
        else:
            print("Op√ß√£o inv√°lida.")

    print(f"\n{Fore.RED}FIM DE JOGO!{Style.RESET_ALL}")

OPONENTE_MODELOS = {
    "Lutador": {
        "nome": "Lutador", "subclasse": "Mestre do Punho", "nivel": 1, 
        "vida": 100, "vigor": 80, "ataque": 15, "defesa": 10, "velocidade": 10,
        "talento": "Poder Focado", "tipo": "Lutador", "gold_recompensa": 20, "exp_recompensa": 50
    },
    "Mestre": {
        "nome": "Mestre", "subclasse": "Vento Veloz", "nivel": 3, 
        "vida": 150, "vigor": 100, "ataque": 25, "defesa": 15, "velocidade": 20,
        "talento": "Vigor Incans√°vel", "tipo": "Mestre", "gold_recompensa": 50, "exp_recompensa": 150
    },
    "Desafiante": {
        "nome": "Desafiante", "subclasse": "Tanque de Ferro", "nivel": 5, 
        "vida": 200, "vigor": 120, "ataque": 30, "defesa": 30, "velocidade": 15,
        "talento": "Mente Clara", "tipo": "Desafiante", "gold_recompensa": 100, "exp_recompensa": 300
    },
    "Lenda": {
        "nome": "Lenda", "subclasse": "Mestre do Punho", "nivel": 7, 
        "vida": 250, "vigor": 150, "ataque": 40, "defesa": 35, "velocidade": 25,
        "talento": "Poder Focado", "tipo": "Lenda", "gold_recompensa": 200, "exp_recompensa": 500
    }
}

MISSOES_DISPONIVEIS = [
    Missao("CA√áA_LUTADORES", "Derrote 5 Lutadores no Dojo.", "derrotar_monstro", "Lutador", "Lutador", 5, 0, 50, 100),
    Missao("CA√áA_MESTRES", "Derrote 3 Mestres no Dojo.", "derrotar_monstro", "Mestre", "Mestre", 3, 0, 100, 250),
    Missao("CA√áA_DESAFIANTES", "Derrote 2 Desafiantes no Dojo.", "derrotar_monstro", "Desafiante", "Desafiante", 2, 0, 150, 400)
]

ITENS_LOJA = [
    Consumivel("Po√ß√£o de PV Pequena", 10, "Restaura 50 Pontos de Vida.", efeito_pv=50),
    Consumivel("Elixir de Vigor Pequeno", 15, "Restaura 30 Pontos de Vigor.", efeito_vigor=30),
    Luva("Luvas de Couro Refor√ßado", 50, 8, "Aumenta o ataque."),
    Quimono("Quimono de Treino Avan√ßado", 60, 5, "Aumenta a defesa."),
    Acessorio("Peso Corporal Leve", 40, 2, "Aumenta a velocidade.")
]

def criar_novo_heroi():
    print(f"\n{Fore.YELLOW}--- CRIA√á√ÉO DE PERSONAGEM ---{Style.RESET_ALL}")
    nome = input("Digite o nome do seu Her√≥i: ")
    
    subclasses = {
        1: "Mestre do Punho",
        2: "Tanque de Ferro",
        3: "Vento Veloz"
    }
    
    while True:
        print("\nEscolha sua Subclasse:")
        print("1. Mestre do Punho (Equilibrado, Foco em Dano)")
        print("2. Tanque de Ferro (Alto PV/Defesa, Foco em Sobreviv√™ncia)")
        print("3. Vento Veloz (Alto Vigor/Velocidade, Foco em Agilidade)")
        
        escolha = input("Op√ß√£o: ")
        if escolha.isdigit() and int(escolha) in subclasses:
            subclasse = subclasses[int(escolha)]
            break
        else:
            print("Escolha inv√°lida.")
            
    heroi = GuerreiroDoPunho(nome, subclasse)
    heroi.escolher_talento()
    
    save_game(heroi, {"OPONENTE_MODELOS": OPONENTE_MODELOS, "MISSOES_DISPONIVEIS": MISSOES_DISPONIVEIS, "ITENS_LOJA": ITENS_LOJA})
    
    return heroi

def main():
    print(f"{Fore.CYAN}*** RPG DO GUERREIRO DO PUNHO ***{Style.RESET_ALL}")
    
    heroi, config_data = load_game()
    
    if heroi:
        print(f"\nBem-vindo de volta, {heroi.nome}!")
    else:
        print("\nNenhum jogo salvo encontrado. Iniciando novo jogo.")
        heroi = criar_novo_heroi()
        
    menu_jogo(heroi)

if __name__ == "__main__":
    main()
