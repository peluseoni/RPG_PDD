import random
import time
import sys
import json
import os
from colorama import Fore, Style, init

init(autoreset=True)

class Missao:
    def __init__(self, id, nome, descricao, tipo, alvo, quantidade, progresso, gold_recompensa, exp_recompensa):
        self.id = id
        self.nome = nome
        self.descricao = descricao
        self.tipo = tipo 
        self.alvo = alvo  
        self.quantidade = quantidade
        self.progresso = progresso
        self.gold_recompensa = gold_recompensa
        self.exp_recompensa = exp_recompensa

    def to_dict(self):
        return {
            "id": self.id,
            "nome": self.nome,
            "descricao": self.descricao,
            "tipo": self.tipo,
            "alvo": self.alvo,
            "quantidade": self.quantidade,
            "progresso": self.progresso,
            "gold_recompensa": self.gold_recompensa,
            "exp_recompensa": self.exp_recompensa
        }

class Item:
    def __init__(self, nome, preco, descricao="Um item comum."):
        self.nome = nome
        self.descricao = descricao
        self.preco = preco 

    def __str__(self):
        return f"{self.nome} (Gold: {self.preco}) - {self.descricao}"
    
    def to_dict(self):
        return {
            "__class__": self.__class__.__name__,
            "nome": self.nome,
            "preco": self.preco,
            "descricao": self.descricao
        }

class Consumivel(Item):
    def __init__(self, nome, preco, descricao, efeito_pv=0, efeito_vigor=0, remove_condicao=None):
        super().__init__(nome, preco, descricao)
        self.efeito_pv = efeito_pv
        self.efeito_vigor = efeito_vigor
        self.remove_condicao = remove_condicao

    def usar(self, alvo):
        usado = False
        if self.efeito_pv > 0:
            alvo.vida = min(alvo.vida_max, alvo.vida + self.efeito_pv)
            print(f"{Fore.GREEN}{alvo.nome} usou {self.nome} e recuperou {self.efeito_pv} PV. Vida atual: {alvo.vida}/{alvo.vida_max}{Style.RESET_ALL}")
            usado = True
        
        if self.efeito_vigor > 0:
            alvo.vigor = min(alvo.vigor_max, alvo.vigor + self.efeito_vigor)
            print(f"{Fore.GREEN}{alvo.nome} usou {self.nome} e recuperou {self.efeito_vigor} Vigor. Vigor atual: {alvo.vigor}/{alvo.vigor_max}{Style.RESET_ALL}")
            usado = True

        if self.remove_condicao and self.remove_condicao in alvo.condicoes:
            del alvo.condicoes[self.remove_condicao]
            print(f"{Fore.GREEN}{alvo.nome} usou {self.nome} e removeu a condi√ß√£o {self.remove_condicao}.{Style.RESET_ALL}")
            usado = True
        
        return usado
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            "efeito_pv": self.efeito_pv,
            "efeito_vigor": self.efeito_vigor,
            "remove_condicao": self.remove_condicao
        })
        return data

class Equipamento(Item):
    def __init__(self, nome, preco, slot, bonus_ataque=0, bonus_defesa=0, bonus_velocidade=0, descricao="Um equipamento."):
        super().__init__(nome, preco, descricao)
        self.slot = slot
        self.bonus_ataque = bonus_ataque
        self.bonus_defesa = bonus_defesa
        self.bonus_velocidade = bonus_velocidade
    
    def to_dict(self):
        data = super().to_dict()
        data.update({
            "slot": self.slot,
            "bonus_ataque": self.bonus_ataque,
            "bonus_defesa": self.bonus_defesa,
            "bonus_velocidade": self.bonus_velocidade
        })
        return data

class Luva(Equipamento):
    def __init__(self, nome, preco, bonus_ataque, descricao="Luvas que aumentam o ataque."):
        super().__init__(nome, preco, "luva", bonus_ataque=bonus_ataque, descricao=descricao)

class Quimono(Equipamento):
    def __init__(self, nome, preco, bonus_defesa, descricao="Quimono que aumenta a defesa."):
        super().__init__(nome, preco, "armadura", bonus_defesa=bonus_defesa, descricao=descricao)

class Acessorio(Equipamento):
    def __init__(self, nome, preco, bonus_velocidade, descricao="Acess√≥rio que aumenta a velocidade."):
        super().__init__(nome, preco, "acessorio", bonus_velocidade=bonus_velocidade, descricao=descricao)

class Habilidade:
    def __init__(self, nome, custo_vigor, dano_base, descricao, nivel_habilidade=1):
        self.nome = nome
        self.custo_vigor = custo_vigor
        self.dano_base = dano_base
        self.descricao = descricao
        self.nivel_habilidade = nivel_habilidade
        self.max_nivel = 5 

    def __str__(self):
        return f"{self.nome} (N√≠vel {self.nivel_habilidade}/{self.max_nivel} | Custo: {self.custo_vigor} Vigor | Dano Base: {self.dano_base}): {self.descricao}"

    def melhorar(self):
        if self.nivel_habilidade < self.max_nivel:
            self.nivel_habilidade += 1
            self.dano_base = int(self.dano_base * 1.1)
            self.custo_vigor = max(5, self.custo_vigor - 1) 
            return True
        return False
    
    def to_dict(self):
        return {
            "__class__": self.__class__.__name__,
            "nome": self.nome,
            "custo_vigor": self.custo_vigor,
            "dano_base": self.dano_base,
            "descricao": self.descricao,
            "nivel_habilidade": self.nivel_habilidade
        }

class Personagem:
    def __init__(self, nome, vida, vigor_max, ataque, defesa, velocidade, nivel=1):
        self.nome = nome
        self.vida_max = vida
        self.vida = vida
        self.vigor_max = vigor_max
        self.vigor = vigor_max
        self.ataque_base = ataque
        self.defesa_base = defesa
        self.velocidade_base = velocidade
        self.nivel = nivel
        self.condicoes = {} 
        self.habilidades = []

    def esta_vivo(self):
        return self.vida > 0

    def get_ataque_total(self):
        return self.ataque_base

    def get_defesa_total(self):
        return self.defesa_base

    def get_velocidade_total(self):
        return self.velocidade_base
    
    def atacar(self, alvo, habilidade=None):
        if 'Atordoado' in self.condicoes:
            print(f"{Fore.YELLOW}{self.nome} est√° Atordoado e n√£o pode agir!{Style.RESET_ALL}")
            return False

        if habilidade:
            custo_vigor_final = habilidade.custo_vigor
            
            if isinstance(self, GuerreiroDoPunho):
                if self.talento == "Vigor Incans√°vel":
                    custo_vigor_final = int(habilidade.custo_vigor * 0.9)

            if self.vigor < custo_vigor_final:
                print(f"{Fore.RED}{self.nome} n√£o tem Vigor suficiente para usar {habilidade.nome}!{Style.RESET_ALL}")
                return False

            self.vigor -= custo_vigor_final
            dano_bruto = habilidade.dano_base + (self.get_ataque_total() * 0.5)
            
            if isinstance(self, GuerreiroDoPunho):
                if 'Atordoado' in alvo.condicoes:
                    self.karma = max(-100, self.karma - 5)
                    print(f"{Fore.RED}{self.nome} atacou um alvo Atordoado. Karma reduzido para {self.karma}.{Style.RESET_ALL}")

                if self.talento == "Poder Focado":
                    dano_bruto += habilidade.dano_base * 0.1

            print(f"{Fore.CYAN}{self.nome} usa {habilidade.nome}!{Style.RESET_ALL}")
        else:
            vigor_gerado = 5
            self.vigor = min(self.vigor_max, self.vigor + vigor_gerado)
            dano_bruto = self.get_ataque_total() * 0.75
            print(f"{self.nome}Desfere um {Fore.GREEN}Ataque B√°sico{Style.RESET_ALL} e gera {vigor_gerado} Vigor.")

        dano_final = max(1, int(dano_bruto - (alvo.get_defesa_total() * 0.5)))
        alvo.receber_dano(dano_final, self)
        return True

    def receber_dano(self, dano, atacante):
        if 'Bloqueio de Guarda' in self.condicoes:
            dano = int(dano * 0.5)
            print(f"{Fore.BLUE}Dano reduzido pela metade devido ao Bloqueio de Guarda!{Style.RESET_ALL}")

        self.vida -= dano
        print(f"{Fore.RED}{self.nome} recebeu {dano} de dano. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
        
        if isinstance(self, GuerreiroDoPunho) and self.esta_vivo():
            habilidade_contra = next((h for h in self.habilidades if h.nome == "Contra-Ataque"), None)
            if habilidade_contra and self.vigor >= habilidade_contra.custo_vigor and dano > 0 and random.random() < 0.5: 
                self.vigor -= habilidade_contra.custo_vigor
                dano_contra = habilidade_contra.dano_base + (self.get_ataque_total() * 0.75)
                print(f"{Fore.YELLOW}{self.nome} REVIDA com Contra-Ataque!{Style.RESET_ALL}")
                atacante.receber_dano(int(dano_contra), self)
                
        if not self.esta_vivo():
            print(f"{Fore.RED}{self.nome} foi derrotado!{Style.RESET_ALL}")

    def aplicar_condicao(self, condicao, duracao):
        if isinstance(self, GuerreiroDoPunho) and self.talento == "Mente Clara" and condicao in ["Sangramento", "Veneno", "Queimadura"]:
            if random.random() < 0.5:
                print(f"{Fore.CYAN}{self.nome} resistiu √† condi√ß√£o {condicao} devido ao Talento Mente Clara!{Style.RESET_ALL}")
                return

        self.condicoes[condicao] = duracao
        print(f"{Fore.YELLOW}{self.nome} agora est√° sob a condi√ß√£o: {condicao} por {duracao} turno(s).{Style.RESET_ALL}")

    def processar_condicoes(self):
        condicoes_para_remover = []
        for condicao, duracao in list(self.condicoes.items()):
            if condicao == 'Sangramento':
                dano_sangramento = int(self.vida_max * 0.05)
                self.vida -= dano_sangramento
                print(f"{Fore.RED} {self.nome} sofre dano de Sangramento: {dano_sangramento}. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
                if not self.esta_vivo():
                    break
            
            elif condicao == 'Veneno':
                dano_veneno = int(self.vida_max * 0.03)
                self.vida -= dano_veneno
                print(f"{Fore.MAGENTA} {self.nome} sofre dano de Veneno: {dano_veneno}. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
                if not self.esta_vivo():
                    break
            
            elif condicao == 'Queimadura':
                dano_queimadura = int(self.vida_max * 0.04)
                self.vida -= dano_queimadura
                print(f"{Fore.YELLOW} {self.nome} sofre dano de Queimadura: {dano_queimadura}. Vida restante: {self.vida}/{self.vida_max}{Style.RESET_ALL}")
                if not self.esta_vivo():
                    break

            if condicao != 'Bloqueio de Guarda':
                self.condicoes[condicao] -= 1
                if self.condicoes[condicao] <= 0:
                    condicoes_para_remover.append(condicao)
            else:
                condicoes_para_remover.append(condicao)

        for condicao in condicoes_para_remover:
            if condicao in self.condicoes:
                del self.condicoes[condicao]
                print(f"{Fore.GREEN}A condi√ß√£o {condicao} em {self.nome} terminou.{Style.RESET_ALL}")

    def recuperar_vigor_turno(self):
        recuperacao = 10 
        if isinstance(self, GuerreiroDoPunho) and self.subclasse == "Sombra Veloz" and self.nivel >= 3:
            recuperacao += 5 
        
        self.vigor = min(self.vigor_max, self.vigor + recuperacao)
        print(f"{Fore.BLUE}{self.nome} recuperou {recuperacao} de Vigor. Vigor atual: {self.vigor}/{self.vigor_max}{Style.RESET_ALL}")

MONSTRO_MODELOS = {
    "Aprendiz": {
        "nome": "Aprendiz do Dojo",
        "nivel": 1,
        "vida": 80,
        "vigor": 40,
        "ataque": 8,
        "defesa": 4,
        "velocidade": 8,
        "gold_recompensa": 10,
        "exp_recompensa": 40,
        "tipo": "Aprendiz"
    },
    "Lutador": {
        "nome": "Lutador Eliminat√≥rio",
        "nivel": 3,
        "vida": 120,
        "vigor": 60,
        "ataque": 15,
        "defesa": 8,
        "velocidade": 12,
        "gold_recompensa": 25,
        "exp_recompensa": 100,
        "tipo": "Lutador"
    },
    "Mestre": {
        "nome": "Mestre do Estilo",
        "nivel": 5,
        "vida": 200,
        "vigor": 100,
        "ataque": 25,
        "defesa": 15,
        "velocidade": 15,
        "gold_recompensa": 50,
        "exp_recompensa": 200,
        "tipo": "Mestre"
    },
    "Desafiante": {
        "nome": "Desafiante do Torneio",
        "nivel": 7,
        "vida": 300,
        "vigor": 120,
        "ataque": 35,
        "defesa": 20,
        "velocidade": 20,
        "gold_recompensa": 80,
        "exp_recompensa": 350,
        "tipo": "Desafiante"
    },
    "Lenda": {
        "nome": "Lenda do Punho",
        "nivel": 10,
        "vida": 500,
        "vigor": 150,
        "ataque": 50,
        "defesa": 30,
        "velocidade": 25,
        "gold_recompensa": 150,
        "exp_recompensa": 600,
        "tipo": "Lenda"
    }
}

class Monstro(Personagem):
    def __init__(self, modelo_key):
        modelo = MONSTRO_MODELOS[modelo_key]
        super().__init__(
            modelo["nome"],
            modelo["vida"],
            modelo["vigor"],
            modelo["ataque"],
            modelo["defesa"],
            modelo["velocidade"],
            modelo["nivel"]
        )
        self.tipo = modelo["tipo"]
        self.gold_recompensa = modelo["gold_recompensa"]
        self.exp_recompensa = modelo["exp_recompensa"]
        self.habilidades.append(Habilidade("Chute R√°pido", 10, 15, "Um chute r√°pido e preciso."))
        
        self.habilidades_condicao = []
        if modelo_key == "Desafiante":
            self.habilidades_condicao.append(("Golpe Venenoso", 20, 10, "Aplica Veneno (3 turnos).", "Veneno", 3))
        elif modelo_key == "Lenda":
            self.habilidades_condicao.append(("Punho Flamejante", 25, 20, "Aplica Queimadura (2 turnos).", "Queimadura", 2))


    def acao_ia(self, heroi):
        if self.habilidades_condicao and random.random() < 0.3:
            nome, custo, dano, desc, condicao, duracao = self.habilidades_condicao[0]
            
            habilidade_cond = Habilidade(nome, custo, dano, desc)
            
            if self.vigor >= custo:
                if self.atacar(heroi, habilidade_cond):
                    heroi.aplicar_condicao(condicao, duracao)
                    return

        if self.habilidades and self.vigor >= self.habilidades[0].custo_vigor and random.random() < 0.7:
            self.atacar(heroi, self.habilidades[0])
            return

        self.atacar(heroi) 

class GuerreiroDoPunho(Personagem):
    def __init__(self, nome, subclasse):
        super().__init__(nome, 100, 50, 10, 5, 10)
        self.subclasse = subclasse
        self.experiencia = 0
        self.exp_para_proximo_nivel = 100
        self.talento = None
        self.gold = 50 
        self.inventario = []
        self.equipamento = {"luva": None, "armadura": None, "acessorio": None} 
        self.pontos_treinamento = 0 
        self.missoes_completas = [] 
        self.missao_ativa = None 
        self.karma = 0 
        
        self.habilidades_classe = [
            Habilidade("Jab R√°pido", 0, 10, "Ataque B√°sico que gera 5 Vigor."),
            Habilidade("Bloqueio de Guarda", 10, 0, "A√ß√£o Defensiva: Pr√≥ximo ataque recebido tem Dano reduzido em 50%."),
            Habilidade("Gancho Poderoso", 15, 30, "Dano alto. Chance de aplicar Atordoamento (1 turno)."),
            Habilidade("Foco de Vigor", 0, 0, "Regenera 15 Vigor instantaneamente (1x por batalha)."),
            Habilidade("Contra-Ataque", 20, 40, "Habilidade de Rea√ß√£o: Causa dano massivo ap√≥s ser atacado (Requer 20 Vigor).")
        ]
        self.habilidades = self.habilidades_classe.copy()
        self.usos_foco_vigor = 1
        self.aplicar_subclasse_habilidades()

    def get_ataque_total(self):
        bonus_luva = self.equipamento["luva"].bonus_ataque if self.equipamento["luva"] else 0
        return self.ataque_base + bonus_luva

    def get_defesa_total(self):
        bonus_armadura = self.equipamento["armadura"].bonus_defesa if self.equipamento["armadura"] else 0
        return self.defesa_base + bonus_armadura
    
    def get_velocidade_total(self):
        bonus_acessorio = self.equipamento["acessorio"].bonus_velocidade if self.equipamento["acessorio"] else 0
        return self.velocidade_base + bonus_acessorio

    def equipar_item(self, item):
        if not isinstance(item, Equipamento):
            print(f"{Fore.RED}N√£o √© poss√≠vel equipar {item.nome}.{Style.RESET_ALL}")
            return False
        
        slot_antigo = self.equipamento[item.slot]
        
        if slot_antigo:
            self.inventario.append(slot_antigo)
            print(f"{Fore.YELLOW}Desequipado: {slot_antigo.nome} e devolvido ao invent√°rio.{Style.RESET_ALL}")
            
        self.equipamento[item.slot] = item
        self.inventario.remove(item)
        print(f"{Fore.GREEN}Equipado: {item.nome} no slot {item.slot}.{Style.RESET_ALL}")
        return True

    def desequipar_item(self, slot):
        item = self.equipamento.get(slot)
        if item:
            self.inventario.append(item)
            self.equipamento[slot] = None
            print(f"{Fore.YELLOW}Desequipado: {item.nome} e devolvido ao invent√°rio.{Style.RESET_ALL}")
            return True
        else:
            print(f"{Fore.RED}Nenhum item equipado no slot {slot}.{Style.RESET_ALL}")
            return False

    def usar_consumivel(self, indice):
        if 0 <= indice < len(self.inventario):
            item = self.inventario[indice]
            if isinstance(item, Consumivel):
                if item.usar(self):
                    self.inventario.pop(indice)
                    return True
                else:
                    print("N√£o foi poss√≠vel usar o item (ex: vida/vigor j√° no m√°ximo ou condi√ß√£o n√£o presente).")
                    return False
            else:
                print("O item escolhido n√£o √© um consum√≠vel.")
                return False
        return False

    def aplicar_subclasse_habilidades(self):
        if self.subclasse == "Sombra Veloz":
            self.velocidade_base += 5
            self.habilidades.append(Habilidade("Ataque Furtivo", 15, 25, "Dano moderado. Chance de aplicar Sangramento (2 turnos)."))
            self.habilidades.append(Habilidade("Evas√£o R√°pida", 10, 0, "Aumenta a velocidade em 10 por 2 turnos."))
        elif self.subclasse == "Tanque de Ferro":
            self.vida_max += 50
            self.vida += 50
            self.defesa_base += 10
            self.habilidades.append(Habilidade("Soco no Corpo", 15, 20, "Dano moderado. Reduz o Vigor M√°ximo do alvo temporariamente."))
            self.habilidades.append(Habilidade("Terremoto de Punho", 25, 35, "Dano alto. Chance de Atordoar o alvo (1 turno)."))

    def ganhar_experiencia(self, exp):
        self.experiencia += exp
        print(f"{Fore.CYAN}Voc√™ ganhou {exp} EXP!{Style.RESET_ALL}")
        while self.experiencia >= self.exp_para_proximo_nivel:
            self.subir_nivel()

    def subir_nivel(self):
        self.nivel += 1
        self.experiencia -= self.exp_para_proximo_nivel
        self.exp_para_proximo_nivel = int(self.exp_para_proximo_nivel * 1.5)
        self.pontos_treinamento += 3
        
        pv_bonus = 10
        vigor_bonus = 5
        pa_bonus = 3
        vel_bonus = 2
        
        self.vida_max += pv_bonus
        self.vida += pv_bonus 
        self.vigor_max += vigor_bonus
        self.ataque_base += pa_bonus
        self.velocidade_base += vel_bonus
        print(f"\n{Fore.GREEN}üéâ PARAB√âNS! Voc√™ alcan√ßou o N√≠vel {self.nivel}!{Style.RESET_ALL}")
        print(f"Atributos base aumentados: +{pv_bonus} PV Max, +{vigor_bonus} Vigor Max, +{pa_bonus} PA, +{vel_bonus} Velocidade.")
        print(f"Voc√™ ganhou {Fore.CYAN}3 Pontos de Treinamento (PT){Style.RESET_ALL}!")

        if self.nivel == 5:
            self.habilidades_classe.append(Habilidade("Ataque Extra", 10, 0, "Permite usar o Ataque B√°sico duas vezes em um turno (custo de 10 Vigor por uso adicional)."))
            self.habilidades.append(self.habilidades_classe[-1])
            print(f"{Fore.CYAN}Habilidade de Classe 'Ataque Extra' desbloqueada!{Style.RESET_ALL}")

        if self.nivel == 4 and not self.talento:
            self.escolher_talento()

        if self.nivel == 5:
            if self.subclasse == "Sombra Veloz":
                self.habilidades.append(Habilidade("Ataque Rasteiro", 25, 40, "Dano alto. Chance de Atordoar o alvo (1 turno)."))
            elif self.subclasse == "Tanque de Ferro":
                self.habilidades.append(Habilidade("Defesa Total", 20, 0, "Aumenta a Defesa em 50% por 2 turnos."))

    def escolher_talento(self):
        while True:
            print(f"\n{Fore.YELLOW}--- ESCOLHA DE TALENTO (N√≠vel 4) ---{Style.RESET_ALL}")
            talentos = {
                1: ("Poder Focado", "O Dano de todas as Habilidades que custam Vigor aumenta em 10%."),
                2: ("Vigor Incans√°vel", "O custo de Vigor de todas as Habilidades √© reduzido em 10%."),
                3: ("Mestre da Dist√¢ncia", "O alcance de ataque das Habilidades aumenta em 1 metro/unidade. (B√¥nus de acerto +5% no 1v1)"),
                4: ("Mente Clara", "Aumenta a resist√™ncia a condi√ß√µes negativas (Sangramento, Veneno, Queimadura) em 50%.")
            }
            
            for i, (nome, descricao) in talentos.items():
                print(f"{i}. {nome}: {descricao}")
            
            escolha = input("Escolha o n√∫mero do Talento: ")
            
            if escolha.isdigit() and int(escolha) in talentos:
                self.talento = talentos[int(escolha)][0]
                print(f"{Fore.GREEN}Talento {self.talento} escolhido!{Style.RESET_ALL}")
                break
            else:
                print("Escolha inv√°lida.")

    def to_dict(self):
        return {
            "nome": self.nome,
            "vida_max": self.vida_max,
            "vida": self.vida,
            "vigor_max": self.vigor_max,
            "vigor": self.vigor,
            "ataque_base": self.ataque_base,
            "defesa_base": self.defesa_base,
            "velocidade_base": self.velocidade_base,
            "nivel": self.nivel,
            "condicoes": self.condicoes,
            "subclasse": self.subclasse,
            "experiencia": self.experiencia,
            "exp_para_proximo_nivel": self.exp_para_proximo_nivel,
            "talento": self.talento,
            "gold": self.gold,
            "pontos_treinamento": self.pontos_treinamento,
            "missoes_completas": self.missoes_completas,
            "missao_ativa": self.missao_ativa.to_dict() if self.missao_ativa else None,
            "karma": self.karma, 
            "usos_foco_vigor": self.usos_foco_vigor,
            "inventario": [item.to_dict() for item in self.inventario],
            "equipamento": {slot: item.to_dict() if item else None for slot, item in self.equipamento.items()},
            "habilidades": [h.to_dict() for h in self.habilidades]
        }

def iniciar_combate(heroi, monstro):
    print(f"\n{Fore.RED}--- COMBATE INICIADO! ---{Style.RESET_ALL}")
    print(f"{Fore.GREEN}{heroi.nome} (N√≠vel {heroi.nivel}){Style.RESET_ALL} vs {Fore.RED}{monstro.nome} (N√≠vel {monstro.nivel}){Style.RESET_ALL}")
    time.sleep(1)

    turno = 1
    heroi.usos_foco_vigor = 1 
    
    heroi_velocidade = heroi.get_velocidade_total()
    if heroi.karma < -50:
        heroi_velocidade = max(1, heroi_velocidade - 5)
        print(f"{Fore.RED}A hostilidade ao seu redor reduz sua velocidade de combate!{Style.RESET_ALL}")

    if heroi_velocidade >= monstro.get_velocidade_total():
        primeiro = heroi
        segundo = monstro
    else:
        primeiro = monstro
        segundo = heroi

    while heroi.esta_vivo() and monstro.esta_vivo():
        print(f"\n{Fore.YELLOW}==== TURNO {turno} ===={Style.RESET_ALL}")
        
        primeiro.processar_condicoes()
        segundo.processar_condicoes()
        
        if not heroi.esta_vivo() or not monstro.esta_vivo():
            break

        primeiro.recuperar_vigor_turno()
        segundo.recuperar_vigor_turno()

        if primeiro.esta_vivo():
            if primeiro == heroi:
                menu_combate(heroi, monstro)
            else:
                primeiro.acao_ia(heroi)
        
        if not heroi.esta_vivo() or not monstro.esta_vivo():
            break

        if segundo.esta_vivo():
            if segundo == heroi:
                menu_combate(heroi, monstro)
            else:
                segundo.acao_ia(heroi)

        turno += 1
        time.sleep(1)

    heroi.venceu = heroi.esta_vivo()
    
    if heroi.venceu:
        print(f"\n{Fore.GREEN}VIT√ìRIA!{Style.RESET_ALL}")
        gold_ganho = monstro.gold_recompensa
        exp_ganha = monstro.exp_recompensa
        
        if heroi.karma > 50:
            bonus = int(gold_ganho * 0.25)
            gold_ganho += bonus
            print(f"{Fore.YELLOW}Sua reputa√ß√£o lhe rendeu um b√¥nus de {bonus} Gold!{Style.RESET_ALL}")

        heroi.gold += gold_ganho
        heroi.ganhar_experiencia(exp_ganha)
        
        if heroi.missao_ativa and heroi.missao_ativa.tipo == "derrotar_monstro" and heroi.missao_ativa.alvo == monstro.tipo:
            heroi.missao_ativa.progresso += 1
            print(f"{Fore.CYAN}Progresso da Miss√£o: {heroi.missao_ativa.progresso}/{heroi.missao_ativa.quantidade}{Style.RESET_ALL}")
        
        print(f"Voc√™ ganhou {Fore.YELLOW}{gold_ganho} Gold{Style.RESET_ALL} e {Fore.CYAN}{exp_ganha} EXP{Style.RESET_ALL}!")
        
        if monstro.vida <= 0:
            print(f"\n{Fore.YELLOW}O corpo de {monstro.nome} jaz no ch√£o. O que voc√™ faz?{Style.RESET_ALL}")
            print("1. Ignorar e seguir em frente.")
            print("2. Prestar os primeiros socorros (Aumenta Karma).")
            
            escolha = input("Op√ß√£o: ")
            if escolha == '2':
                heroi.karma = min(100, heroi.karma + 5)
                print(f"{Fore.GREEN}Voc√™ demonstrou piedade. Karma aumentado para {heroi.karma}.{Style.RESET_ALL}")

        return True 
    else:
        print(f"\n{Fore.RED}DERROTA!{Style.RESET_ALL}")
        exp_ganha = int(monstro.exp_recompensa * 0.5)
        heroi.ganhar_experiencia(exp_ganha)
        print(f"Voc√™ ganhou {Fore.CYAN}{exp_ganha} EXP{Style.RESET_ALL} de consola√ß√£o.")
        return False

def iniciar_torneio(heroi):
    if heroi.nivel < 5:
        print(f"{Fore.RED}Voc√™ deve ser no m√≠nimo N√≠vel 5 para entrar no Torneio do Punho Ascendente!{Style.RESET_ALL}")
        return False
    
    missao_torneio = heroi.missao_ativa and heroi.missao_ativa.id == "TORNEIO"
    
    if missao_torneio:
        print(f"{Fore.YELLOW}Iniciando o Torneio, objetivo da Miss√£o Principal!{Style.RESET_ALL}")

    print(f"\n{Fore.MAGENTA}*** TORNEIO DO PUNHO ASCENDENTE INICIADO! ***{Style.RESET_ALL}")
    oponentes = ["Lutador", "Mestre", "Desafiante", "Lenda"]
    vitorias = 0
    
    for nome_oponente in oponentes:
        monstro = Monstro(nome_oponente)
        print(f"\n{Fore.YELLOW}--- PR√ìXIMO OPONENTE: {monstro.nome} ---{Style.RESET_ALL}")
        time.sleep(1)
        
        if not iniciar_combate(heroi, monstro):
            print(f"{Fore.RED}Voc√™ foi derrotado por {monstro.nome} e eliminado do Torneio!{Style.RESET_ALL}")
            return False
        
        vitorias += 1
        print(f"\n{Fore.GREEN}Vit√≥ria contra {monstro.nome}! Prepare-se para o pr√≥ximo round.{Style.RESET_ALL}")
        heroi.vida = heroi.vida_max 
        heroi.vigor = heroi.vigor_max
        heroi.usos_foco_vigor = 1
        input("Pressione ENTER para continuar para o pr√≥ximo round...")

    print(f"\n{Fore.YELLOW}*** PARAB√âNS! VOC√ä √â O CAMPE√ÉO DO TORNEIO DO PUNHO ASCENDENTE! ***{Style.RESET_ALL}")
    
    gold_premio = 500
    exp_premio = 1000
    
    heroi.gold += gold_premio
    heroi.ganhar_experiencia(exp_premio)
    
    item_unico = Luva("Punho do Destino", 1000, 25, "Luvas lend√°rias. +25 Ataque. N√£o pode ser vendido.")
    heroi.inventario.append(item_unico)
    
    print(f"{Fore.YELLOW}Recompensa: {gold_premio} Gold, {exp_premio} EXP e o item lend√°rio '{item_unico.nome}'!{Style.RESET_ALL}")
    
    return True

def menu_combate(heroi, alvo):
    while True:
        print(f"\n{Fore.GREEN}--- SEU TURNO ---{Style.RESET_ALL}")
        print(f"PV: {Fore.RED}{heroi.vida}/{heroi.vida_max}{Style.RESET_ALL} | Vigor: {Fore.BLUE}{heroi.vigor}/{heroi.vigor_max}{Style.RESET_ALL} | Condi√ß√µes: {', '.join(heroi.condicoes.keys()) if heroi.condicoes else 'Nenhuma'}")
        print(f"Alvo PV: {Fore.RED}{alvo.vida}/{alvo.vida_max}{Style.RESET_ALL} | Alvo Condi√ß√µes: {', '.join(alvo.condicoes.keys()) if alvo.condicoes else 'Nenhuma'}")
        
        print("\nOp√ß√µes:")
        print("1. Ataque B√°sico (Gera Vigor)")
        print("2. Habilidades de Combate")
        print("3. Usar Item Consum√≠vel")
        
        escolha = input("Escolha a a√ß√£o: ")
        
        if escolha == '1':
            heroi.atacar(alvo)
            break
        elif escolha == '2':
            if menu_habilidades(heroi, alvo):
                break
        elif escolha == '3':
            if acao_item_combate(heroi):
                break
        else:
            print("Op√ß√£o inv√°lida.")

def menu_habilidades(heroi, alvo):
    habilidades_validas = [h for h in heroi.habilidades if h.nome != "Jab R√°pido"]
    
    if not habilidades_validas:
        print("Voc√™ n√£o possui Habilidades de A√ß√£o.")
        return False

    print(f"\n{Fore.YELLOW}--- HABILIDADES DISPON√çVEIS ---{Style.RESET_ALL}")
    for i, h in enumerate(habilidades_validas):
        custo_final = h.custo_vigor
        if heroi.talento == "Vigor Incans√°vel":
            custo_final = int(h.custo_vigor * 0.9)

        if heroi.vigor >= custo_final:
            print(f"{i+1}. {h.nome} (N√≠vel {h.nivel_habilidade} | Custo: {Fore.BLUE}{custo_final} Vigor{Style.RESET_ALL}) - {h.descricao}")
        else:
            print(f"{i+1}. {h.nome} (N√≠vel {h.nivel_habilidade} | {Fore.RED}Vigor Insuficiente - Custo: {custo_final}{Style.RESET_ALL})")
    
    print("0. Voltar")

    while True:
        escolha = input("Escolha a Habilidade (0 para voltar): ")
        if escolha == '0':
            return False
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(habilidades_validas):
            habilidade_escolhida = habilidades_validas[int(escolha) - 1]
            
            if habilidade_escolhida.nome == "Bloqueio de Guarda":
                custo = habilidade_escolhida.custo_vigor
                if heroi.vigor < custo:
                    print(f"{Fore.RED}Vigor insuficiente para Bloqueio de Guarda.{Style.RESET_ALL}")
                    continue
                heroi.aplicar_condicao("Bloqueio de Guarda", 1)
                heroi.vigor -= custo
                print(f"{Fore.BLUE} {heroi.nome} assume Postura de Bloqueio de Guarda.{Style.RESET_ALL}")
                return True
            
            elif habilidade_escolhida.nome == "Gancho Poderoso":
                if heroi.atacar(alvo, habilidade_escolhida):
                    if random.random() < 0.3: 
                        alvo.aplicar_condicao("Atordoado", 1)
                    return True
                return False
            
            elif habilidade_escolhida.nome == "Foco de Vigor":
                if heroi.usos_foco_vigor > 0:
                    heroi.vigor = min(heroi.vigor_max, heroi.vigor + 15)
                    heroi.usos_foco_vigor -= 1
                    print(f"{Fore.YELLOW} {heroi.nome} foca o Vigor. +15 Vigor. Usos restantes: {heroi.usos_foco_vigor}{Style.RESET_ALL}")
                    return True
                else:
                    print(f"{Fore.RED}Voc√™ j√° usou Foco de Vigor nesta batalha.{Style.RESET_ALL}")
                    continue
            
            elif habilidade_escolhida.nome == "Soco no Corpo":
                if heroi.atacar(alvo, habilidade_escolhida):
                    alvo.vigor_max = max(10, alvo.vigor_max - 5) 
                    alvo.vigor = min(alvo.vigor, alvo.vigor_max)
                    print(f"{Fore.YELLOW} Vigor M√°ximo de {alvo.nome} reduzido para {alvo.vigor_max}.{Style.RESET_ALL}")
                    return True
                return False

            elif habilidade_escolhida.nome == "Terremoto de Punho":
                if heroi.atacar(alvo, habilidade_escolhida):
                    alvo.aplicar_condicao("Atordoado", 1)
                    return True
                return False
            
            elif habilidade_escolhida.nome == "Combo Girat√≥rio":
                if heroi.atacar(alvo, habilidade_escolhida): 
                    dano_adicional = heroi.get_ataque_total() * 0.5
                    alvo.receber_dano(int(dano_adicional), heroi)
                    alvo.receber_dano(int(dano_adicional), heroi)
                    return True
                return False

            elif heroi.atacar(alvo, habilidade_escolhida):
                return True
            return False

        else:
            print("Escolha inv√°lida.")

def acao_item_combate(heroi):
    consumiveis = [item for item in heroi.inventario if isinstance(item, Consumivel)]
    
    if not consumiveis:
        print("Voc√™ n√£o tem itens consum√≠veis no invent√°rio.")
        return False

    print(f"\n{Fore.YELLOW}--- CONSUM√çVEIS DISPON√çVEIS ---{Style.RESET_ALL}")
    for i, item in enumerate(consumiveis):
        print(f"{i+1}. {item.nome} - {item.descricao}")
    
    print("0. Voltar")

    while True:
        escolha = input("Escolha o Item para usar (0 para voltar): ")
        if escolha == '0':
            return False
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(consumiveis):
            item_escolhido = consumiveis[int(escolha) - 1]
            
            indice_real = heroi.inventario.index(item_escolhido)
            
            if heroi.usar_consumivel(indice_real):
                return True
            else:
                continue 
        else:
            print("Escolha inv√°lida.")

def mostrar_status(heroi):
    print(f"\n{Fore.GREEN}--- STATUS DO HER√ìI ---{Style.RESET_ALL}")
    print(f"Nome: {heroi.nome}")
    print(f"Classe: Guerreiro do Punho ({heroi.subclasse})")
    print(f"N√≠vel: {heroi.nivel}")
    print(f"Experi√™ncia: {heroi.experiencia}/{heroi.exp_para_proximo_nivel}")
    print(f"Pontos de Treinamento: {Fore.CYAN}{heroi.pontos_treinamento}{Style.RESET_ALL}")
    print(f"Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
    
    karma_status = "Neutro"
    karma_cor = Style.RESET_ALL
    if heroi.karma > 50:
        karma_status = "Bom"
        karma_cor = Fore.GREEN
    elif heroi.karma < -50:
        karma_status = "Mau"
        karma_cor = Fore.RED
    print(f"Karma: {karma_cor}{heroi.karma} ({karma_status}){Style.RESET_ALL}")

    print(f"Vida: {Fore.RED}{heroi.vida}/{heroi.vida_max}{Style.RESET_ALL}")
    print(f"Vigor: {Fore.BLUE}{heroi.vigor}/{heroi.vigor_max}{Style.RESET_ALL}")
    print(f"Ataque Total: {heroi.get_ataque_total()} (Base: {heroi.ataque_base})")
    print(f"Defesa Total: {heroi.get_defesa_total()} (Base: {heroi.defesa_base})")
    print(f"Velocidade: {heroi.get_velocidade_total()} (Base: {heroi.velocidade_base})")
    print(f"Talento: {heroi.talento if heroi.talento else 'Nenhum'}")
    print(f"Condi√ß√µes: {', '.join(heroi.condicoes.keys()) if heroi.condicoes else 'Nenhuma'}")
    print("\n--- EQUIPAMENTOS ---")
    print(f"Luva: {heroi.equipamento['luva'].nome if heroi.equipamento['luva'] else 'Nenhuma'}")
    print(f"Armadura: {heroi.equipamento['armadura'].nome if heroi.equipamento['armadura'] else 'Nenhuma'}")
    print(f"Acess√≥rio: {heroi.equipamento['acessorio'].nome if heroi.equipamento['acessorio'] else 'Nenhuma'}")
    print("-------------------------")

def menu_inventario(heroi):
    while True:
        print(f"\n{Fore.GREEN}--- INVENT√ÅRIO ({len(heroi.inventario)} itens) ---{Style.RESET_ALL}")
        print(f"Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        
        itens_equipaveis = [item for item in heroi.inventario if isinstance(item, Equipamento)]
        itens_consumiveis = [item for item in heroi.inventario if isinstance(item, Consumivel)]
        
        itens_exibicao = itens_equipaveis + itens_consumiveis
        
        if not itens_exibicao:
            print("Seu invent√°rio est√° vazio.")
        
        for i, item in enumerate(itens_exibicao):
            tipo = type(item).__name__
            status_equipado = ""
            if item in heroi.equipamento.values():
                status_equipado = f" ({Fore.RED}EQUIPADO{Style.RESET_ALL})"
            print(f"{i+1}. {item.nome} ({tipo}){status_equipado} - {item.descricao}")
            
        print("\nOp√ß√µes:")
        print("1. Usar Consum√≠vel")
        print("2. Equipar Equipamento")
        print("3. Desequipar Equipamento")
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Escolha a op√ß√£o: ")
        
        if escolha == '0':
            break
        
        elif escolha == '1':
            if not itens_consumiveis:
                print(f"{Fore.RED}Nenhum item consum√≠vel no invent√°rio.{Style.RESET_ALL}")
                continue
            
            print(f"\n{Fore.YELLOW}--- USAR CONSUM√çVEL ---{Style.RESET_ALL}")
            for i, item in enumerate(itens_consumiveis):
                print(f"{i+1}. {item.nome} - {item.descricao}")
            
            sub_escolha = input("Digite o n√∫mero do item para usar (0 para voltar): ")
            if sub_escolha == '0': continue
            
            if sub_escolha.isdigit() and 1 <= int(sub_escolha) <= len(itens_consumiveis):
                item_escolhido = itens_consumiveis[int(sub_escolha) - 1]
                indice_real = heroi.inventario.index(item_escolhido)
                heroi.usar_consumivel(indice_real)
            else:
                print("Escolha inv√°lida.")
                
        elif escolha == '2':
            if not itens_equipaveis:
                print(f"{Fore.RED}Nenhum item equip√°vel no invent√°rio.{Style.RESET_ALL}")
                continue
            
            print(f"\n{Fore.YELLOW}--- EQUIPAR EQUIPAMENTO ---{Style.RESET_ALL}")
            for i, item in enumerate(itens_equipaveis):
                print(f"{i+1}. {item.nome} ({item.slot}) - {item.descricao}")
            
            sub_escolha = input("Digite o n√∫mero do item para equipar (0 para voltar): ")
            if sub_escolha == '0': continue
            
            if sub_escolha.isdigit() and 1 <= int(sub_escolha) <= len(itens_equipaveis):
                item_escolhido = itens_equipaveis[int(sub_escolha) - 1]
                heroi.equipar_item(item_escolhido)
            else:
                print("Escolha inv√°lida.")

        elif escolha == '3':
            print(f"\n{Fore.YELLOW}--- DESEQUIPAR EQUIPAMENTO ---{Style.RESET_ALL}")
            slots_equipados = [s for s, item in heroi.equipamento.items() if item]
            
            if not slots_equipados:
                print("Nenhum equipamento para desequipar.")
                continue

            for i, slot in enumerate(slots_equipados):
                print(f"{i+1}. {heroi.equipamento[slot].nome} (Slot: {slot})")
            
            sub_escolha = input("Digite o n√∫mero do item para desequipar (0 para voltar): ")
            if sub_escolha == '0': continue
            
            if sub_escolha.isdigit() and 1 <= int(sub_escolha) <= len(slots_equipados):
                slot_escolhido = slots_equipados[int(sub_escolha) - 1]
                heroi.desequipar_item(slot_escolhido)
            else:
                print("Escolha inv√°lida.")

def menu_melhoria_personagem(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- TREINAMENTO E EVOLU√á√ÉO ---{Style.RESET_ALL}")
        print(f"Pontos de Treinamento (PT): {Fore.CYAN}{heroi.pontos_treinamento}{Style.RESET_ALL}")
        print("\nOp√ß√µes:")
        print("1. Aumentar Atributo Base (1 PT)")
        print("2. Aumentar N√≠vel de Habilidade (2 PT)")
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Escolha a op√ß√£o: ")
        
        if escolha == '0':
            break
        
        elif escolha == '1':
            if heroi.pontos_treinamento < 1:
                print(f"{Fore.RED}PTs insuficientes.{Style.RESET_ALL}")
                continue
            
            print("\nEscolha o Atributo para Aumentar (+5):")
            print("1. Ataque Base")
            print("2. Defesa Base")
            print("3. Velocidade Base")
            
            sub_escolha = input("Op√ß√£o: ")
            
            if sub_escolha == '1':
                heroi.ataque_base += 5
                heroi.pontos_treinamento -= 1
                print(f"{Fore.GREEN}Ataque Base aumentado para {heroi.ataque_base}.{Style.RESET_ALL}")
            elif sub_escolha == '2':
                heroi.defesa_base += 5
                heroi.pontos_treinamento -= 1
                print(f"{Fore.GREEN}Defesa Base aumentada para {heroi.defesa_base}.{Style.RESET_ALL}")
            elif sub_escolha == '3':
                heroi.velocidade_base += 5
                heroi.pontos_treinamento -= 1
                print(f"{Fore.GREEN}Velocidade Base aumentada para {heroi.velocidade_base}.{Style.RESET_ALL}")
            else:
                print("Op√ß√£o inv√°lida.")
                
        elif escolha == '2':
            if heroi.pontos_treinamento < 2:
                print(f"{Fore.RED}PTs insuficientes (Custo: 2 PT).{Style.RESET_ALL}")
                continue
            
            print("\nEscolha a Habilidade para Aumentar o N√≠vel (2 PT):")
            habilidades_melhoraveis = [h for h in heroi.habilidades if h.nivel_habilidade < h.max_nivel and h.nome != "Jab R√°pido"]
            
            if not habilidades_melhoraveis:
                print("Nenhuma habilidade para melhorar.")
                continue
            
            for i, h in enumerate(habilidades_melhoraveis):
                print(f"{i+1}. {h.nome} (N√≠vel {h.nivel_habilidade}/{h.max_nivel})")
            
            sub_escolha = input("Op√ß√£o: ")
            
            if sub_escolha.isdigit() and 1 <= int(sub_escolha) <= len(habilidades_melhoraveis):
                habilidade_escolhida = habilidades_melhoraveis[int(sub_escolha) - 1]
                if habilidade_escolhida.melhorar():
                    heroi.pontos_treinamento -= 2
                    print(f"{Fore.GREEN}Habilidade {habilidade_escolhida.nome} melhorada para N√≠vel {habilidade_escolhida.nivel_habilidade}.{Style.RESET_ALL}")
                else:
                    print(f"{Fore.RED}Habilidade j√° est√° no n√≠vel m√°ximo.{Style.RESET_ALL}")
            else:
                print("Op√ß√£o inv√°lida.")

def menu_dojo(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- DOJO DE TREINAMENTO ---{Style.RESET_ALL}")
        print("Escolha o oponente para treinar:")
        
        opcoes = list(MONSTRO_MODELOS.keys())
        for i, nome in enumerate(opcoes):
            modelo = MONSTRO_MODELOS[nome]
            print(f"{i+1}. {nome} (N√≠vel {modelo['nivel']}) - Recompensa: {modelo['exp_recompensa']} EXP / {modelo['gold_recompensa']} Gold")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Op√ß√£o: ")
        
        if escolha == '0':
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(opcoes):
            nome_monstro = opcoes[int(escolha) - 1]
            monstro = Monstro(nome_monstro)
            iniciar_combate(heroi, monstro)
        else:
            print("Op√ß√£o inv√°lida.")

def loja_consumiveis(heroi):
    itens_loja = [
        Consumivel("Po√ß√£o de PV Pequena", 10, "Restaura 50 Pontos de Vida.", efeito_pv=50),
        Consumivel("Elixir de Vigor Pequeno", 15, "Restaura 30 Pontos de Vigor.", efeito_vigor=30),
        Consumivel("Bandagem de Seda", 25, "Remove a condi√ß√£o Sangramento.", remove_condicao="Sangramento"),
        Consumivel("Ant√≠doto", 30, "Remove a condi√ß√£o Veneno.", remove_condicao="Veneno"),
        Consumivel("Pomada Refrescante", 35, "Remove a condi√ß√£o Queimadura.", remove_condicao="Queimadura")
    ]
    
    while True:
        print(f"\n{Fore.YELLOW}--- LOJA DE CONSUM√çVEIS ---{Style.RESET_ALL}")
        print(f"Seu Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        
        for i, item in enumerate(itens_loja):
            print(f"{i+1}. {item.nome} (Pre√ßo: {item.preco} Gold) - {item.descricao}")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Digite o n√∫mero do item para comprar (0 para voltar): ")
        
        if escolha == '0':
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(itens_loja):
            item_escolhido = itens_loja[int(escolha) - 1]
            
            if heroi.gold >= item_escolhido.preco:
                heroi.gold -= item_escolhido.preco
                heroi.inventario.append(item_escolhido)
                print(f"{Fore.GREEN} {item_escolhido.nome} comprado! Gold restante: {heroi.gold}{Style.RESET_ALL}")
            else:
                print(f"{Fore.RED}Gold insuficiente para comprar {item_escolhido.nome}.{Style.RESET_ALL}")
        else:
            print("Escolha inv√°lida.")

def vender_item(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- VENDA DE ITENS ---{Style.RESET_ALL}")
        print(f"Seu Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        
        itens_vendaveis = []
        for item in heroi.inventario:
            if item.nome != "Punho do Destino":
                itens_vendaveis.append(item)

        if not itens_vendaveis:
            print("Voc√™ n√£o tem itens vend√°veis no invent√°rio.")
            input("Pressione ENTER para continuar...")
            break

        print("\nItens no Invent√°rio:")
        for i, item in enumerate(itens_vendaveis):
            preco_venda = int(item.preco * 0.5)
            status_equipado = ""
            if item in heroi.equipamento.values():
                status_equipado = f" ({Fore.RED}EQUIPADO{Style.RESET_ALL})"

            print(f"{i+1}. {item.nome} (Venda: {Fore.YELLOW}{preco_venda} Gold{Style.RESET_ALL}){status_equipado}")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Digite o n√∫mero do item para vender (0 para voltar): ")
        
        if escolha == '0':
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(itens_vendaveis):
            item_escolhido = itens_vendaveis[int(escolha) - 1]
            
            if item_escolhido in heroi.equipamento.values():
                print(f"{Fore.RED} Voc√™ precisa desequipar {item_escolhido.nome} antes de vend√™-lo.{Style.RESET_ALL}")
                continue

            preco_venda = int(item_escolhido.preco * 0.5)
            heroi.gold += preco_venda
            heroi.inventario.remove(item_escolhido)
            
            print(f"{Fore.GREEN} {item_escolhido.nome} vendido por {preco_venda} Gold! Total: {heroi.gold}{Style.RESET_ALL}")
        else:
            print("Escolha inv√°lida.")

def loja_equipamentos(heroi):
    itens_loja = [
        Luva("Luvas de Couro Refor√ßado", 50, 8, "Aumenta o ataque."),
        Quimono("Quimono de Treino Avan√ßado", 60, 5, "Aumenta a defesa."),
        Acessorio("Peso Corporal Leve", 40, 2, "Aumenta a velocidade."),
        Luva("Manoplas de Ferro", 120, 15, "Aumenta muito o ataque."),
        Quimono("Quimono de Seda Refor√ßada", 150, 10, "Aumenta a defesa e a velocidade."),
        Acessorio("Faixa da Agilidade", 100, 5, "Aumenta muito a velocidade.")
    ]
    
    while True:
        print(f"\n{Fore.YELLOW}--- LOJA DE EQUIPAMENTOS ---{Style.RESET_ALL}")
        print(f"Seu Gold: {Fore.YELLOW}{heroi.gold}{Style.RESET_ALL}")
        
        for i, item in enumerate(itens_loja):
            print(f"{i+1}. {item.nome} (Pre√ßo: {item.preco} Gold) - Slot: {item.slot.capitalize()}")
            
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Digite o n√∫mero do item para comprar (0 para voltar): ")
        
        if escolha == '0':
            break
        
        if escolha.isdigit() and 1 <= int(escolha) <= len(itens_loja):
            item_escolhido = itens_loja[int(escolha) - 1]
            
            if heroi.gold >= item_escolhido.preco:
                heroi.gold -= item_escolhido.preco
                heroi.inventario.append(item_escolhido)
                print(f"{Fore.GREEN} {item_escolhido.nome} comprado! Gold restante: {heroi.gold}{Style.RESET_ALL}")
            else:
                print(f"{Fore.RED}Gold insuficiente para comprar {item_escolhido.nome}.{Style.RESET_ALL}")
        else:
            print("Escolha inv√°lida.")

def menu_lojas(heroi):
    while True:
        print(f"\n{Fore.YELLOW}--- LOJAS DE KAIRU ---{Style.RESET_ALL}")
        print("1. Loja de Consum√≠veis")
        print("2. Loja de Equipamentos")
        print("3. Vender Itens")
        print("0. Voltar ao Menu Principal")
        
        escolha = input("Escolha a loja: ")
        
        if escolha == '1':
            loja_consumiveis(heroi)
        elif escolha == '2':
            loja_equipamentos(heroi)
        elif escolha == '3':
            vender_item(heroi)
        elif escolha == '0':
            break
        else:
            print("Op√ß√£o inv√°lida.")

def menu_jogo(heroi):
    print("\n" + Fore.YELLOW + "="*50)
    print(f"üó∫Ô∏è CIDADE DE KAIRU - DOJO CENTRAL")
    print("="*50 + Style.RESET_ALL)

    if not heroi.missao_ativa and "TORNEIO" not in heroi.missoes_completas:
        heroi.missao_ativa = Missao("TORNEIO", "Conquistar o t√≠tulo de Mestre Invicto no Torneio do Punho Ascendente.", "vencer_torneio", "Torneio", 1, 0, 500, 1000)
    
    if "TORNEIO" in heroi.missoes_completas and "DERROTAR_MESTRES" not in heroi.missoes_completas and not heroi.missao_ativa:
        heroi.missao_ativa = Missao("DERROTAR_MESTRES", "Derrote 3 Mestres para receber uma recompensa especial.", "derrotar_monstro", "Mestre", 3, 0, 150, 300)

    while heroi.esta_vivo():
        
        if heroi.missao_ativa and heroi.missao_ativa.progresso >= heroi.missao_ativa.quantidade:
            print(f"\n{Fore.YELLOW} MISS√ÉO COMPLETA: {heroi.missao_ativa.nome}!{Style.RESET_ALL}")
            heroi.gold += heroi.missao_ativa.gold_recompensa
            heroi.ganhar_experiencia(heroi.missao_ativa.exp_recompensa)
            heroi.missoes_completas.append(heroi.missao_ativa.id)
            heroi.missao_ativa = None
            input("Pressione ENTER para continuar...")

        if random.random() < 0.1: 
            print(f"\n{Fore.YELLOW}Um jovem monge se aproxima de voc√™ no Dojo.{Style.RESET_ALL}")
            print("Ele lhe pergunta: 'Qual √© o caminho mais r√°pido para a vit√≥ria?'")
            print("1. 'O caminho mais r√°pido √© o mais brutal. N√£o hesite em usar todos os meios.' (Karma -10)")
            print("2. 'A verdadeira vit√≥ria est√° na honra e no respeito ao oponente.' (Karma +10)")
            
            escolha = input("Op√ß√£o: ")
            if escolha == '1':
                heroi.karma = max(-100, heroi.karma - 10)
                print(f"{Fore.RED}Seu Karma foi reduzido para {heroi.karma}.{Style.RESET_ALL}")
            elif escolha == '2':
                heroi.karma = min(100, heroi.karma + 10)
                print(f"{Fore.GREEN}Seu Karma foi aumentado para {heroi.karma}.{Style.RESET_ALL}")
            input("Pressione ENTER para continuar...")


        print("\nO que voc√™ deseja fazer?")
        print("1. Dojo de Treinamento (Escolher Oponente)")
        print(f"{Fore.MAGENTA}2. Torneio do Punho Ascendente (Desafio Final){Style.RESET_ALL}")
        print(f"3. Treinamento e Evolu√ß√£o ({Fore.CYAN}{heroi.pontos_treinamento} PTs dispon√≠veis{Style.RESET_ALL})")
        print("4. Gerenciar Invent√°rio e Equipamentos")
        print("5. Lojas (Consum√≠veis e Equipamentos)")
        print("6. Curandeiro (Restaurar PV/Vigor)")
        print("7. Ver Status")
        print(f"{Fore.GREEN}8. Salvar Jogo{Style.RESET_ALL}")
        print("9. Sair do Jogo")
        
        if heroi.missao_ativa:
            print(f"{Fore.CYAN}QUEST ATIVA: {heroi.missao_ativa.nome} - {heroi.missao_ativa.descricao}{Style.RESET_ALL}")
            if heroi.missao_ativa.tipo == "derrotar_monstro":
                print(f"{Fore.CYAN}Progresso: {heroi.missao_ativa.progresso}/{heroi.missao_ativa.quantidade} {heroi.missao_ativa.alvo} derrotados.{Style.RESET_ALL}")
            elif heroi.missao_ativa.tipo == "vencer_torneio":
                status = "COMPLETA" if "TORNEIO" in heroi.missoes_completas else "PENDENTE"
                print(f"{Fore.CYAN}Status: {status}{Style.RESET_ALL}")
        
        escolha = input("Op√ß√£o: ")

        if escolha == '1':
            menu_dojo(heroi)
        
        elif escolha == '2':
            venceu_torneio = iniciar_torneio(heroi)
            if venceu_torneio and "TORNEIO" not in heroi.missoes_completas:
                heroi.missoes_completas.append("TORNEIO")
                print(f"\n{Fore.YELLOW}üèÜ MISS√ÉO PRINCIPAL CONCLU√çDA!{Style.RESET_ALL}")
                input("Pressione ENTER para continuar...")
        
        elif escolha == '3':
            menu_melhoria_personagem(heroi)
        
        elif escolha == '4':
            menu_inventario(heroi)
        
        elif escolha == '5':
            menu_lojas(heroi)

        elif escolha == '6':
            heroi.vida = heroi.vida_max
            heroi.vigor = heroi.vigor_max
            heroi.usos_foco_vigor = 1 
            print(f"{Fore.GREEN} Vigor e Vida totalmente restaurados!{Style.RESET_ALL}")
        
        elif escolha == '7':
            mostrar_status(heroi)

        elif escolha == '8':
            salvar_jogo(heroi)
            continue

        elif escolha == '9':
            print("Saindo do Jogo.")
            break
        
        else:
            print("Op√ß√£o inv√°lida.")

def introducao_jogo():
    print("\n" + Fore.YELLOW + "="*70)
    print("           O PUNHO DO DESTINO: O RPG DE TURNO EM KAIRU")
    print("="*70 + Style.RESET_ALL)
    time.sleep(1)

    print(f"\n{Fore.CYAN}BEM-VINDO A KAIRU.{Style.RESET_ALL}")
    print("Uma cidade portu√°ria vibrante, onde o ar √© carregado com o cheiro de incenso, suor e a promessa de gl√≥ria. Kairu √© o centro do Vigor, a energia vital que flui atrav√©s de todos os seres.")
    time.sleep(2)
    
    print("Voc√™ √© Kai, o √∫ltimo disc√≠pulo do Dojo da Montanha, destru√≠do por um ataque trai√ßoeiro. As √∫ltimas palavras do seu Mestre ecoam em sua mente:")
    print(f"{Fore.MAGENTA}>> 'O Vigor n√£o √© apenas for√ßa, Kai. √â a escolha de como us√°-lo. Seu punho pode ser o do destino, mas o destino √© seu para moldar.'{Style.RESET_ALL}")
    time.sleep(3)
    
    print("Seu objetivo √© claro: Treinar no Dojo Central, provar seu valor e, finalmente, conquistar o t√≠tulo de Mestre Invicto no lend√°rio **Torneio do Punho Ascendente**.")
    print("Somente o campe√£o tem o direito de empunhar o **Punho do Destino** e restaurar a honra do seu Mestre.")
    time.sleep(3)
    
    print(f"\n{Fore.GREEN}Sua jornada come√ßa agora. Que seu Vigor o guie.{Style.RESET_ALL}")
    input("\nPressione ENTER para iniciar o jogo...")

def reconstruct_item(item_data):
    if not item_data:
        return None
    
    item_class_name = item_data.pop("__class__")
    
    if item_class_name == "Consumivel":
        return Consumivel(**item_data)
    elif item_class_name == "Luva":
        item_data["slot"] = "luva"
        return Luva(item_data["nome"], item_data["preco"], item_data["bonus_ataque"], item_data["descricao"])
    elif item_class_name == "Quimono":
        item_data["slot"] = "armadura"
        return Quimono(item_data["nome"], item_data["preco"], item_data["bonus_defesa"], item_data["descricao"])
    elif item_class_name == "Acessorio":
        item_data["slot"] = "acessorio"
        return Acessorio(item_data["nome"], item_data["preco"], item_data["bonus_velocidade"], item_data["descricao"])
    elif item_class_name == "Equipamento":
        return Equipamento(**item_data)
    elif item_class_name == "Item":
        return Item(**item_data)
    return None

def reconstruct_habilidade(h_data):
    return Habilidade(h_data["nome"], h_data["custo_vigor"], h_data["dano_base"], h_data["descricao"], h_data["nivel_habilidade"])


def reconstruir_heroi(data):
    heroi = GuerreiroDoPunho(data["nome"], data["subclasse"])
    
    heroi.vida_max = data["vida_max"]
    heroi.vida = data["vida"]
    heroi.vigor_max = data["vigor_max"]
    heroi.vigor = data["vigor"]
    heroi.ataque_base = data["ataque_base"]
    heroi.defesa_base = data["defesa_base"]
    heroi.velocidade_base = data["velocidade_base"]
    heroi.nivel = data["nivel"]
    heroi.condicoes = data["condicoes"]
    heroi.experiencia = data["experiencia"]
    heroi.exp_para_proximo_nivel = data["exp_para_proximo_nivel"]
    heroi.talento = data["talento"]
    heroi.gold = data["gold"]
    heroi.pontos_treinamento = data.get("pontos_treinamento", 0)
    heroi.usos_foco_vigor = data.get("usos_foco_vigor", 1)
    heroi.missoes_completas = data.get("missoes_completas", [])
    heroi.karma = data.get("karma", 0) 

    missao_data = data.get("missao_ativa")
    if missao_data:
        heroi.missao_ativa = Missao(missao_data["id"], missao_data["nome"], missao_data["descricao"], missao_data["tipo"], missao_data["alvo"], missao_data["quantidade"], missao_data["progresso"], missao_data["gold_recompensa"], missao_data["exp_recompensa"])
    else:
        heroi.missao_ativa = None

    heroi.inventario = [reconstruct_item(item_data) for item_data in data["inventario"]]

    heroi.equipamento = {}
    for slot, item_data in data["equipamento"].items():
        heroi.equipamento[slot] = reconstruct_item(item_data)

    heroi.habilidades = [reconstruct_habilidade(h_data) for h_data in data["habilidades"]]
    
    return heroi

def salvar_jogo(heroi):
    try:
        with open("save_game.json", "w", encoding="utf-8") as f:
            json.dump(heroi.to_dict(), f, indent=4, ensure_ascii=False)
        print(f"{Fore.GREEN} Jogo salvo com sucesso em 'save_game.json'!{Style.RESET_ALL}")
    except Exception as e:
        print(f"{Fore.RED} Erro ao salvar o jogo: {e}{Style.RESET_ALL}")

def carregar_jogo():
    try:
        with open("save_game.json", "r", encoding="utf-8") as f:
            data = json.load(f)
        
        heroi = reconstruir_heroi(data)
        print(f"{Fore.GREEN} Jogo carregado com sucesso! Bem-vindo de volta, {heroi.nome}.{Style.RESET_ALL}")
        return heroi
    except FileNotFoundError:
        print(f"{Fore.YELLOW}Nenhum arquivo de save encontrado. Iniciando novo jogo.{Style.RESET_ALL}")
        return None
    except Exception as e:
        print(f"{Fore.RED} Erro ao carregar o jogo: {e}{Style.RESET_ALL}")
        return None

def criar_personagem():
    print(f"\n{Fore.YELLOW}--- CRIA√á√ÉO DE PERSONAGEM ---{Style.RESET_ALL}")
    nome = input("Digite o nome do seu Guerreiro do Punho: ")
    
    while True:
        print("\nEscolha sua Subclasse:")
        print("1. Sombra Veloz (Foco em Velocidade e Dano R√°pido)")
        print("2. Tanque de Ferro (Foco em Vida e Defesa)")
        escolha = input("Op√ß√£o: ")
        
        if escolha == '1':
            subclasse = "Sombra Veloz"
            break
        elif escolha == '2':
            subclasse = "Tanque de Ferro"
            break
        else:
            print("Op√ß√£o inv√°lida.")
            
    heroi = GuerreiroDoPunho(nome, subclasse)
    print(f"\n{Fore.GREEN}Seu Guerreiro do Punho, {heroi.nome} ({heroi.subclasse}), est√° pronto para a jornada!{Style.RESET_ALL}")
    return heroi

def menu_inicial():
    while True:
        print(f"\n{Fore.YELLOW}--- O PUNHO DO DESTINO ---{Style.RESET_ALL}")
        print("1. Novo Jogo")
        print("2. Carregar Jogo")
        print("3. Sair")
        
        escolha = input("Op√ß√£o: ")
        
        if escolha == '1':
            heroi = criar_personagem()
            menu_jogo(heroi)
        elif escolha == '2':
            heroi = carregar_jogo()
            if heroi:
                menu_jogo(heroi)
        elif escolha == '3':
            sys.exit()
        else:
            print("Op√ß√£o inv√°lida.")

if __name__ == "__main__":
    introducao_jogo()
    menu_inicial()
